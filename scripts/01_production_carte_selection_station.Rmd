---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Production d'une carte des opérations sélectionnées"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne 

Script : 01_production_carte_selection_station

Après avoir sélectionné les différentes stations / points de prélèvements et opérations de pêches de l'aire géographique ciblée, une carte globale est réalisée.  


# Installation 

## Chargement des packages et des données 

```{r Chargement des packages}
## Chargement des packages 
library(ggplot2)
library(sf)
library(cowplot)
library(png)
library(rnaturalearth)
```

```{r Chargement des données}
## Chargement des données 
load(file = "../processed_data/selection_pop_ope_carte.rda")

## Chargement de la palette de couleur 
pal <- c("#007844", "#92D050", "#0087C1", "#A97B30","#FCEE21", "#00AEEF", "#1D1D1B", "#B9D9EB")
```



# Création de la carte 

## Création de la carte de situation

Il s'agit de créer une petite carte de situation permettant de situer l'aire géographique étudiée à l'échelle de la France. 

```{r Carte situation}
# Sélection de la zone géographique d'ensemble (ici l'étude est en France)
france <- ne_countries(country = "france", returnclass = "sf")

# Création de la carte de la France avec une zone de focus (ici la Bretagne)
carte_france_dept <- ggplot(data = france) + 
  geom_sf(fill = "gray82", color = "black") +
  theme_void() +
  annotate("path",
           x = -3.24 + 1.75 * cos(seq(0, 2 * pi, length.out = 100)),
           y = 48.2 + 1.0 * sin(seq(0, 2 * pi, length.out = 100)),
           color = "red", size = 1) +
  xlim(-5, 10) +
  ylim(40, 52) +
  theme(panel.background = element_rect(fill = "white", color = "black"))

```

```{r Carte convertie Grob}
# Convertir la carte de France en un objet grob 
carte_france_dept_grob <- ggplotGrob(carte_france_dept)
```


## Création de la carte station

Il s'agit de créer la carte principale regroupant les stations étudiées. 

```{r Création carte station}
carte_sta <- ggplot(sta_id_ope_selection) +
  geom_sf(data = mes_depts) +
  geom_sf(data = buffer) +
  geom_sf(aes(color = DEP), size = 2) +
  scale_color_manual(values = pal) +
  theme_bw() +
  # Ajouter une légende pour la variable DEP
  labs(color = "Département") +
  theme(legend.position = "bottom")

```


Je souhaite ajouter de nouvelles couches (de manière expériementale)

```{r}
nouvelle_couche <- st_read("../QGIS/bv/BVSpeMasseDEauSurface_edl2019.shp")
```


```{r}
carte_sta <- ggplot(sta_id_ope_selection) +
  geom_sf(data = mes_depts) +
  geom_sf(data = buffer) +
  geom_sf(data = nouvelle_couche) +  # Ajout de la nouvelle couche
  geom_sf(aes(color = DEP), size = 2) +
  scale_color_manual(values = pal) +
  theme_bw() +
  labs(color = "Département") +
  theme(legend.position = "bottom")

```



# Création carte finale

Il s'agit de combiner les deux cartes créées précédemment. 

```{r Construction carte finale}

# Assemblage des cartes pré-créée
carte_combinee <- ggdraw() +
  draw_plot(carte_sta) +
  draw_plot(carte_france_dept, x = 0, y = 0, width = 0.4, height = 0.25, hjust = 0.05, vjust = -0.75)

# Charger l'image du logo
logo <- readPNG( "../assets/ofb_logo.png")

# Créer la carte combinée avec le logo
carte_combinee <- carte_combinee + 
  annotation_raster(logo, xmin = 0.8, xmax = 0.98, ymin = 0.015, ymax = 0.13)

carte_combinee
```




