---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "GLM"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne
13_GLM

Ce script a pour objectif d'evaluer l'impact qu'ont les différents réseaux sur les tendances des indicateurs. On évalue également l'impact des changements de protocoles grâce à cette technique. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library(dplyr)

library(lme4)
library(lmerTest)
library(car)
library(flextable)
```

```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")

## Chargement des tables ASPE ----
rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)

```

```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
```

```{r}
#utils::install.packages("lme4", type = "source")
```



# Modèles Linéaires Généralisés (GLM)

Utilisation des modèles GLM afin de modéliser la distribution des espèces - ces modèles sont utiles pour modéliser la dynamique des populations en fonction de facteurs environementaux.

On souhaite construire un df avec les valeurs de l'indicateur "densite" et une espèces pour un exemple. on ajoute les réseaux et les protocoles : 

```{r}

ope_indicateur_glm_ex <- ope_indicateur %>% 
  filter(indicateur == "densite_surface",
         stade == "ind",
         esp_code_alternatif == "GAR") %>% 
  mef_ajouter_type_protocole() %>% 
  mef_ajouter_objectif() %>% 
  select(-obi_id)

```

## Effet réseaux - GLM 

```{r}
effet_reseaux <- lmer(valeur ~ annee + pro_libelle + (1 | obj_libelle / pop_id), 
                      data = ope_indicateur_glm_ex)

  # estimation du modèle
effet_reseaux_test <- lmerTest::lmer (valeur ~ annee + pro_libelle + (1 | obj_libelle / pop_id), 
                      data = ope_indicateur_glm_ex)

# ajustement pour l'estimation des effets fixes
mod_effet_reseaux_test <- update(effet_reseaux_test, REML=FALSE)

summary(mod_effet_reseaux_test)


```



```{r}
  # estimation du modèle
effet_reseaux_test_2 <- lmerTest::lmer (valeur ~ annee + (1 | obj_libelle / pop_id), 
                      data = ope_indicateur_glm_ex)

# ajustement pour l'estimation des effets fixes
mod_effet_reseaux_test_2 <- update(effet_reseaux_test_2, REML=FALSE)

summary(mod_effet_reseaux_test_2)
```

