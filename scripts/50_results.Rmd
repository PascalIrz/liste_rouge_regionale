---
title: "Fish population trends the rivers of Britanny"
subtitle: "Results"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
  bookdown::word_document2:
always_allow_html: true
params:
  refnet_start: 2013
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{css, echo = FALSE}
p.caption {
    font-size: 0.9em;
    font-style: italic;
    color: grey;
    margin-right: 10%;
    margin-left: 10%;  
    text-align: justify;
}
```


```{r}
# install packages
# devtools::install_github("pascalirz/aspe")
library(aspe)
library(tidyverse)
library(flextable)

# install custom functions
source("../R/functions.R")
source("../R/gg_temp_fbi.R")
source("../R/gg_box_env_fbi_trend.R")

# load data
load(file = "../processed_data/20_selected_data.RData")
load(file = "../processed_data/30_indicators.RData")
load(file = "../processed_data/40_trends.RData")
```

# The dataset

## The networks

From the overall dataset of the Aspe database, only 2 monitoring networks are considered here.

-   Réseau de Contrôle de Surveillance (RCS)\
-   Réseau Hydrobiologique Piscicole (RHP)

The former two are monitoring networks considered representative of the diversity of the rivers ecosystems in continental France and operated unmodified since 2007. Pooled together, they are further referred to as "REPNET". The RRP (perennial reference network) encompasses only minimally-impacted sites. It is operated unmodified since 2013, and further referred to as "REFNET". 

Note that one site can contribute to more than one network (true also for one survey).

## Data selection

> *Are the sampling sites distributed evenly in space?*

The points sizes indicate the number of years the site has been surveyed.

```{r}
mapview::mapviewOptions(fgb = FALSE)

points_geo %>% 
  mapview::mapview(cex = "n_ope",
                   layer.name = "Nb of surveys",
                   min.rad = 4,
                   max.rad = 8,
                   row.numbers = FALSE,
                   popup = leafpop::popupTable(points_geo, feature.id = FALSE))
```

## Sampling effort across time

How many sites sampled by year?

```{r}
surveys %>% 
  group_by(annee) %>% 
  summarise(n_ope = n_distinct(pop_id)) %>% 
  ggplot(aes(x = annee, y = n_ope)) +
    geom_bar(stat = "identity") +
  labs(x = "Year",
       y = "Nb of sites surveyed")
```


# Populations trends

```{r}
# assembly of the dataframe
# sp_trends <- sp_trends_refnet %>% 
#   mutate(network = "REFNET") %>% 
#   filter(annee >= params$refnet_start) %>% 
#   rbind(sp_trends_repnet %>% 
#           mutate(network = "REPNET")) %>% 
#   complete(esp_nom_latin, annee, variable)
```



```{r, fig.height = 30, fig.width = 12, dpi = 300, fig.cap = "Temporal trend in the fish populations indicators. Each point is the annual mean value of the indicator. Solid regression lines indicate that the Mann-Kendall trend test is significant at the 5% threshold. All the indicators for a given species are on a row."}
data <- sp_trends %>% 
  mutate(indicator = as.factor(indicator),
         indicator = fct_relevel(indicator, "density", "occurency_rate", "false_abs", "true_pres")) %>% 
  filter(!esp_nom_latin == "Abramis brama") # because density & occ plots refer to A. brama while
                                            # the models refer to A. brama + B bjoerkna

g_sp_trends_indicators(
  df = data,
  var_x = annee,
  var_y = value,
  var_facet_col = indicator,
  var_facet_row = esp_nom_latin,
  var_sig = trend,
  scales = "free_y",
  x_lab = "Year",
  y_lab = "",
  ncol = 5
) 
  
```

## The breams

```{r, fig.height = 6, fig.width = 7, dpi = 300, fig.cap = "Temporal trend in the fish populations indicators. Each point is the annual mean value of the indicator. Solid regression lines indicate that the Mann-Kendall trend test is significant at the 5% threshold. All the indicators for a given species are on a row."}
data <- sp_trends %>% 
  mutate(indicator = as.factor(indicator),
         indicator = fct_relevel(indicator, "density", "occurency_rate", "false_abs", "true_pres")) %>% 
  filter(!esp_nom_latin == "Abramis brama") # because density & occ plots refer to A. brama while
                                            # the models refer to A. brama + B bjoerkna

g_sp_trends_indicators(
  df = data,
  var_x = annee,
  var_y = value,
  var_facet_col = indicator,
  var_facet_row = esp_nom_latin,
  var_sig = trend,
  scales = "free_y",
  x_lab = "Year",
  y_lab = "",
  ncol = 5
) 
  
```


# FBI trends at sites

To assess the significance of a monotonous temporal trend for each sampling point, a Mann-Kendall non-parametric test is performed. Sen-Theil slope is then estimated in order to retrieve its sign. As the FBI score is a measure of degradation, both are positively correlated. Hence, if the trend is significant and the sign is positive, FBI scores tend to increase through time, reflecting a degradation of the river. On the contrary, a significant trend with a negative sign indicates an improvement of 'river health'.

## FBI

```{r, fig.cap = "Map of the Fish-based index trends."}
map_data <- points_geo %>%
  left_join(fbi_trends_by_point) %>%
  filter(!is.na(trend)) 

ggplot() +
  geom_sf(data = background) +
  geom_sf(data = map_data,
          aes(col = trend,
              size = (trend != "No trend"))) +
  scale_color_manual(name = "FBI trend",
                     values = c(
    "Degradation" = "red",
    "Improvement" = "darkgreen",
    "No trend" = "gray"
  )) +
  scale_size_manual(values = c(0.8, 2),
                    guide = 'none') +
  geom_sf(
    data = district_limits,
    size = 0.8,
    col = "darkred",
    alpha = 0
  ) +
  theme(panel.background = element_rect(fill = "lightblue")) +
  coord_sf(xlim = c(-5.4, 8.4),
           ylim = c(42, 51.2),
           expand = FALSE) 
```

```{r}
data <- map_data %>% 
  sf::st_drop_geometry() %>% 
  left_join(y = points_ref_status_2_cats) %>% 
  select(pop_id, network, trend) %>% 
  unique() %>%
  group_by(network) %>% 
  count(trend) 

totals <- data %>% 
  group_by(network) %>% 
  summarise(n_sites = sum(n))

data <- data %>% 
  left_join(y = totals) %>% 
  mutate(prop = 100 * n / n_sites,
         prop = paste0(round(prop, 1), "%"),
         prop = paste0(prop, " (n=", n, ")")) %>% 
  select(-n, -n_sites) %>% 
  pivot_wider(names_from = c(trend, network),
              values_from = prop) %>% 
  select(4, 1, 5, 2, 6, 3)
# 
# 
# data <- data %>% 
#   mutate(prop_repnet = REPNET / totals["REPNET"],
#          prop_refnet = REFNET / totals["REFNET"]) %>% 
#   select(trend, REPNET, REFNET, prop_repnet, prop_refnet) %>% 
#   mutate(across(starts_with("prop"), ~paste0(round(.x * 100, digits = 1), "%")))

data %>%  
  flextable::flextable() %>% 
  flextable::set_caption("Count and proportion of sites according to the Fish-based index trends.") %>% 
  flextable::set_header_labels(
    Degradation_REPNET = "REPNET",
    Degradation_REFNET = "REFNET",
    Improvement_REPNET = "REPNET",
    Improvement_REFNET = "REFNET",
    `No trend_REPNET` = "REPNET",
    `No trend_REFNET` = "REFNET") %>%
    flextable::align(align = "center", part = "all") %>% 
      flextable::autofit() %>% 
    flextable::add_header_row(values = c("Degradation", "Improvement", "No trend"),
      colwidths = c(2, 2, 2)) %>% 
   flextable::align(i = 1, align = "center", part = "header") %>% 
     flextable::color(j = c(2, 4, 6), color = "green3", part = "body") %>% 
   flextable::color(j = c(1, 3, 5), color = "brown", part = "body")
```

```{r, fig.cap = "Comparison between the proportions of sites in improving and degradation conditions according to the FBI, across regions (dear co-authors, note that the regions are not those of the map ! This will be fixed is this plot and the map are both kept). The regions are ordered by their proportion of sites in degradation."}
n_fbi_points_trends_by_basin <- fbi_trends_by_point %>%
  group_by(unh_libelle, trend) %>%
  tally()

n_fbi_points_by_basin <- fbi_trends_by_point %>%
  group_by(unh_libelle) %>%
  tally() %>%
  rename(n_tot = n)

pc_fbi_points_trends_by_basin <- n_fbi_points_trends_by_basin %>%
  left_join(n_fbi_points_by_basin) %>%
  filter(trend != "No trend") %>%
  ungroup() %>%
  mutate(
    pc = n / n_tot,
    unh_libelle = str_replace(unh_libelle, "Bassin ", ""),
    unh_libelle = as.factor(unh_libelle)
  ) %>%
  select(-n) %>%
  pivot_wider(names_from = trend,
              values_from = pc) %>%
  mutate(unh_libelle = fct_reorder(unh_libelle, Degradation)) %>%
  pivot_longer(Degradation:Improvement,
               names_to = "trend",
               values_to = "pc") %>%
  ggplot(aes(x = unh_libelle,
             y = pc,
             fill = trend)) +
  geom_bar(stat = "identity",
           position = "dodge") +
  scale_fill_manual(values = c("red", "darkgreen")) +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  labs(x = "Bassin",
       y = "",
       fill = "FBI trend")

pc_fbi_points_trends_by_basin
```

```{r, fig.cap = "Comparison between the environmental characteristics of the sites according to the FBI trends. The y axis il log_transformed."}
env_point_mean <- env_surveys %>% 
  group_by(pop_id, variable) %>% 
  summarise(env_value = median(value, na.rm = TRUE)) %>% 
  ungroup()
  
test <- fbi_trends_by_point %>% 
  left_join(env_point_mean) %>% 
  filter(!is.na(env_value))

gg_box_env_fbi_trend(df = test,
                     var_y = env_value,
                     var_x = trend,
                     var_facet = variable,
                     var_metric = metric)
  
```

## FBI metrics

### Mapping

> *Are some regions more prone than others to degradation measured by each of tthe metrics?*

```{r, fig.width = 10, fig.height = 10}
map_data <- points_geo %>%
  left_join(fbi_metrics_trends_by_point) %>%
  filter(!is.na(trend))

ggplot() +
  geom_sf(data = background) +
  geom_sf(data = map_data,
          aes(col = trend,
              size = (trend != "No trend"))) +
  scale_color_manual(
    name = "FBI trend",
    values = c(
      "No trend" = "gray",
      "Degradation" = "red",
      "Improvement" = "darkgreen"
    )
  ) +
  scale_size_manual(values = c(0.2, 1.2),
                    guide = 'none') +
  geom_sf(
    data = district_limits,
    size = 0.8,
    col = "darkred",
    alpha = 0
  ) +
  theme(panel.background = element_rect(fill = "lightblue")) +
  coord_sf(xlim = c(-5.4, 8.4),
           ylim = c(42, 51.2),
           expand = FALSE) +
  facet_wrap(vars(metric))
```

> *Are all metrics similarly prone to temporal trends?*

```{r}
data <- fbi_metrics_trends_by_point %>% 
  left_join(y = points_ref_status_2_cats) %>% 
  select(pop_id, metric, network, trend) %>% 
  unique() %>% 
  group_by(trend, metric, network) %>% 
  tally()

data <- data %>% 
  left_join(y = totals) %>% 
  mutate(prop = 100 * n / n_sites,
         prop = paste0(round(prop, 1), "%"),
         prop = paste0(prop, " (n=", n, ")")) %>% 
  select(-n, -n_sites) %>% 
  pivot_wider(names_from = c(trend, network),
              values_from = prop) %>% 
  select(1, 3, 2, 5, 4, 7, 6)


data %>%  
  flextable::flextable() %>% 
  flextable::set_caption("Count and proportion of sites according to the Fish-based index metrics trends.") %>%
  flextable::set_header_labels(
    metric = "Metric",
    Degradation_REPNET = "REPNET",
    Degradation_REFNET = "REFNET",
    Improvement_REPNET = "REPNET",
    Improvement_REFNET = "REFNET",
    `No trend_REPNET` = "REPNET",
    `No trend_REFNET` = "REFNET") %>%
    flextable::align(align = "center", part = "all") %>% 
    flextable::align(j = 1, align = "left", part = "all") %>% 
    flextable::autofit() %>% 
   flextable::align(align = "center", part = "header") %>% 
   flextable::color(j = c(3, 5, 7), color = "green3", part = "body") %>% 
   flextable::color(j = c(2, 4, 6), color = "brown", part = "body") %>% 
   flextable::add_header_row(values = c("", "Degradation", "Improvement", "No trend"),
      colwidths = c(1, 2, 2, 2))
```

> *For each metric, do the sites displaying improvement or degradation differ from the others in terms of environmental characteristics?*

```{r, , results = 'hide', fig.cap = "Comparison between the environmental characteristics of the sites according to the FBI metrics trends. The y axis is log-transformed."}
test <- fbi_metrics_trends_by_point %>% 
  left_join(env_point_mean) %>% 
  filter(!is.na(env_value))

metrics <- unique(test$metric)

map(
  .x = metrics,
  .f = gg_box_env_fbi_trend,
  df = test,
  var_y = env_value,
  var_x = trend,
  var_facet = variable,
  var_metric = metric
)
```

# Species contributions

## Species contributions to mean FBI scores

For a given species, this contribution is obtained by averaging, across surveys, the species contribution to the FBI score:

- For each survey, calculate the differences between the actual FBI score and the one that would be obtained should the species be removed.
- Average these values across surveys

As the FBI score increases when 'river health' deteriorates, a species with a positive mean contribution to FBI scores is a species whose presence indicates a degradation.

```{r, fig.cap = "Mean contribution of the species to the FBI scores for REFNET and REPNET. The species are ordered by increasing contribution in REFNET. The presence of the species with green bars, on average, improves (=lowers) the FBI score."}
g_fbi_species_mean_contributions1
```

Link between the taxa mean contributions on REFNET and on REPNET?

```{r, fig.cap = "Mean contribution of the species to the FBI scores: REFNET vs. REPNET."}
g_fbi_species_mean_contributions2
```

Same plot without *Salmo trutta* and *Cottus spp* to focus on the other species that are overpacked above.

```{r, fig.cap = "Mean contribution of the species to the FBI scores: REFNET vs. REPNET."}
g_fbi_species_mean_contributions3
```

$\Rightarrow$ Clear link between the species mean contributions to FBI scores in REFNET and in REPNET.

## Species contributions FBI scores temporal trends

The contribution of a given taxa to the temporal trend of the nationwide FBI score is the difference between the observed Sen-Theil slope of the annual median FBI score and the same slope on the scores obtained, should this taxa be removed.

```{r, fig.cap = "Contribution of the species to the temporal trend in the annual median FBI score for REFNET and REPNET. The species are ordered by increasing contribution in REFNET. The dynamics of the species with green bars, on average, improves the FBI score temporal trend, i.e. they have a negative contribution to the slope."}
g_species_effect_on_fbi_trend1
```

```{r, fig.cap = "Contribution of the species to the temporal trend in the annual median FBI score: REFNET vs. REPNET."}
g_species_effect_on_fbi_trend2
```

*Salmo trutta* is an outlier that prevents a clear view for the other species, so we can redo the plot excluding *S. trutta*.

```{r, fig.cap = "Contribution of the species to the temporal trend in the annual median FBI score: REFNET vs. REPNET, excluding *Salmo trutta*."}
g_species_effect_on_fbi_trend3
```

$\Rightarrow$ No clear link between the species contributions to the FBI temporal trends in REFNET and in REPNET.