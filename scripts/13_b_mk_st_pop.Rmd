---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Mann-Kendall / Sen-Theil par pop_id"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne

Script : 13b_mk_st_par_pop_id

# Chargement des packages :

```{r Chargement des packages}
library(tidyverse)
library(trend)
library(sf)
library(COGiter)
```

# Chargement des données :

```{r Chargement de la palette}
## Chargement de la palette de couleur 
pal <- c("#007844", "#92D050", "#0087C1", "#A97B30","#FCEE21", "#00AEEF", "#1D1D1B", "#B9D9EB")
```


```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
load(file = "../processed_data/selection_pop_ope_carte.rda")
```


```{r Chargement des fonctions}
## Chargement des fonctions ----
source(file = "../R/mk_st_by_group.R")
source(file = "../R/calcul_taux_evolution.R")
source(file = "../R/mann_kendall_sen.R")
```


```{r}
mes_especes <- c("ANG","BRO", "CHA", "CHE","PER", "GAR", "GOU", "LOF", "LPP","SAT", "TRF", "VAI", "VAR")
```




# Distribution des espèces (significativité avec test mk_st par points de prélèvements)

```{r}
ope_densite <- ope_indicateur %>% 
  filter(esp_code_alternatif %in% mes_especes,
         indicateur == "densite_surface",
         stade == "ind") # Nous avons 7475 observations (sans les absences)
```


On ajoute au dataframe les absences : 

```{r}
ope_esp_densite <- ope_densite %>% 
  select(-esp_code_alternatif, -valeur) %>% 
  distinct() # df regroupant toutes mes opérations

# Création d'un dataframe avec toutes les combinaisons possibles d'années, indicateurs, stades et esp_code_alternatif
combinaisons_ope_densite <- expand.grid(esp_code_alternatif = unique(ope_densite$esp_code_alternatif),
                                    ope_id = unique(ope_densite$ope_id))

ope_densite_complet <- ope_esp_densite %>% 
  left_join(y = combinaisons_ope_densite) %>% 
  left_join(y = ope_densite) %>% 
  mutate(valeur = ifelse(is.na(valeur), 0, valeur)) # Nous avons maintenant 13663 observations (avec les absences : 1051 opérations * 13 espèces)

```



## Pour la période LRR

```{r Filtre ope_densite_periode_lrr}
# On filtre les périodes d'étude de la Liste Rouge Régionale
ope_densite_periode_lrr <- ope_densite_complet %>%
  filter((esp_code_alternatif == "ANG" & annee >= 1990) |
      (esp_code_alternatif %in% c("CHE", "LPP") & annee >= 2005) |
      (esp_code_alternatif %in% c("BRO", "LOF", "VAR") & annee >= 2008) |
      (esp_code_alternatif %in% c("GAR", "VAI", "PER") & annee >= 2011) |
      (esp_code_alternatif %in% c("SAT", "GOU", "TRF", "CHA") & annee >= 2013))


ope_densite_periode_lrr_sans_abs <- ope_densite %>%
  filter((esp_code_alternatif == "ANG" & annee >= 1990) |
      (esp_code_alternatif %in% c("CHE", "LPP") & annee >= 2005) |
      (esp_code_alternatif %in% c("BRO", "LOF", "VAR") & annee >= 2008) |
      (esp_code_alternatif %in% c("GAR", "VAI", "PER") & annee >= 2011) |
      (esp_code_alternatif %in% c("SAT", "GOU", "TRF", "CHA") & annee >= 2013)) %>% 
  select(esp_code_alternatif,
         pop_id) %>% 
  distinct()

```


Calcul des tendances par points de prélèvements sur la période d'étude LRR : 

```{r Calcul tendances lrr avec mk_st}
ope_densite_tendances_mk_st_lrr <- mk_st_by_group(ope_densite_periode_lrr,
                                                   valeur,
                                                   annee,
                                                   esp_code_alternatif,
                                                   indicateur,
                                                   stade,
                                                   pop_id) # Variable de groupage
```


# Pour la période globale (30 ans)

```{r test mk_st période globale}
# Calculate results
ope_densite_tendances_mk_st_globale <- mk_st_by_group(ope_densite_complet,
                                                      valeur,
                                                      annee,
                                                      esp_code_alternatif,
                                                      indicateur,
                                                      stade,
                                                      pop_id) # Variable de groupage
```



On renomme les variables en français
```{r}
# Remplacer les valeurs
ope_densite_tendances_mk_st_globale <- ope_densite_tendances_mk_st_globale %>%
  mutate(trend = recode(trend, "Decrease" = "Diminution", "Increase" = "Augmentation", "No trend" = "Non significative")) %>% 
  rename(Tendance = trend)

ope_densite_tendances_mk_st_lrr <- ope_densite_tendances_mk_st_lrr %>%
  mutate(trend = recode(trend, "Decrease" = "Diminution", "Increase" = "Augmentation", "No trend" = "Non significative")) %>% 
  rename(Tendance = trend)
```




## Représentation graphique
Préparation des données géographiques (carte de fond)

```{r préparation background}
mes_depts <- departements_metro_geo %>% 
  filter(DEP %in% c("22", "29", "35", "56", "53", "44", "50", "49")) %>% 
  st_transform(crs = 4326) %>% 
  st_crop(
    xmin = -5,
    xmax = -0.9,
    ymin = 47.4,
    ymax = 49
  )
```



## Pour la période LRR : 

On ne veut faire que apparaitre les points où il y a déjà eu de la présence : 

```{r}
ope_densite_code_periode_lrr <- ope_densite_periode_lrr %>% 
  select(esp_code_alternatif, 
         pop_id) %>% 
  distinct()

ope_densite_code_complet_periode_lrr <- ope_densite_periode_lrr_sans_abs %>% 
  left_join(ope_densite_tendances_mk_st_lrr)
```

```{r Calcul mk_st, fig.height = 10, fig.width = 11}
# Combine data and plot with facet_wrap
carte_tendance_lrr <- ggplot(sta_id_ope_selection %>% 
                            left_join(ope_densite_code_complet_periode_lrr, 
                                      by = "pop_id") %>% 
                            filter(esp_code_alternatif %in% c("ANG", 
                                                              "CHE", 
                                                              "LPP", 
                                                              "BRO", 
                                                              "LOF", 
                                                              "GAR", 
                                                              "VAI", 
                                                              "VAR",
                                                              "PER", 
                                                              "SAT", 
                                                              "GOU", 
                                                              "TRF", 
                                                              "CHA")) %>%
                            filter(!is.na(Tendance))) +
  geom_sf(data = mes_depts, fill = "white", color = "black") +
  geom_sf(data = buffer, fill = NA, color = "grey") +
  geom_sf(aes(col = Tendance, 
              size = (Tendance != "Non significative"))) +
  scale_color_manual(name = "Tendance",
                     values = c("Diminution" = "red",
                                "Augmentation" = "darkgreen",
                                "Non significative" = "gray")) +
  scale_size_manual(values = c(0.8, 2),
                    guide = 'none') +
  facet_wrap(~ esp_code_alternatif) +
  theme(panel.background = element_rect(fill = "lightblue"),
        legend.position = "bottom",
        legend.key = element_rect(fill = NA),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 0.5), # Ajustements ici
        plot.margin = unit(c(1, 1, 1, 1), "cm"))  +
   ggtitle("Tendances temporelles des densités par espèces à l'échelle des points de prélèvement - période LRR ")

carte_tendance_lrr + coord_sf(xlim = c(-5, -1.2), ylim = c(47.45, 48.8), default_crs = 4326)

```






## Pour la période globale

On ne veut faire que apparaitre les points où il y a déjà eu de la présence : 
```{r}
ope_densite_code <- ope_densite %>% 
  select(esp_code_alternatif, 
         pop_id) %>% 
  distinct()

ope_densite_code_complet <- ope_densite_code %>% 
  left_join(ope_densite_tendances_mk_st_globale)
```


Représentation de la carte globale

```{r Carte période complète, fig.height = 10, fig.width = 11}
# Combine data and plot with facet_wrap
carte_sta_facet_globale <- ggplot(sta_id_ope_selection %>% 
                            left_join(ope_densite_code_complet, by = "pop_id") %>% 
                            filter(esp_code_alternatif %in% c("ANG", "CHE", "LPP", "BRO", "LOF", "GAR", "VAI", "VAR", "PER", "SAT", "GOU", "TRF", "CHA"))) +
  geom_sf(data = mes_depts, fill = "white", color = "black") +
  geom_sf(data = buffer, fill = NA, color = "grey") +
  geom_sf(aes(col = Tendance, 
              size = (Tendance != "Non significative"))) +
  scale_color_manual(name = "Tendance",
                     values = c("Diminution" = "red",
                                "Augmentation" = "darkgreen",
                                "Non significative" = "gray"
                     )) +
  scale_size_manual(values = c(0.8, 2),
                    guide = 'none') +
  facet_wrap(~ esp_code_alternatif) +
  theme(panel.background = element_rect(fill = "lightblue"),
        legend.position = "bottom",
        legend.key = element_rect(fill = NA),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 0.5), # Ajustements ici
        plot.margin = unit(c(1, 1, 1, 1), "cm"))  +
  ggtitle("Tendances temporelles des densités par espèce à l'échelle des points de prélèvement - période globale (30 ans)")

carte_sta_facet_globale + coord_sf(xlim = c(-5, -1.2), ylim = c(47.45, 48.8), default_crs = 4326)
# Ne pas oublier de rajouter la légrende : seuls les points échantillonés au moins une fois sur la période de temps étudiée apparaissent 
```














