---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Prétraitement des données individuelles des espèces"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  passage_a_retirer: !r c("2","3") # Sélection du nombre de passage souhaité ; Remarque : si je souhaite enlever les 1ers passages, sélection "0","1" 
  type_lot_a_retirer: !r c("G") # Sélection des lots à retirer du jeu de données ; tyl_libelle  = G (cf ref_type_lot)
  type_peche_a_inclure: !r c("Pêche complète à un ou plusieurs passages",
                            "Pêche partielle par points (grand milieu)",
                            "Pêche par ambiances",
                            "Pêche partielle sur berge") # Selection des types de pêches à inclure au jeu de données (pro_libelle)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne - 04_pre_traitements_donnees_tailles_poids

Pour les espèces contenues dans nos données, on cherche à identifier les valeurs abérrantes de tailles et de poids. 

# Installation 

## Chargement des packages et des données 

```{r}
devtools::install_github("PascalIrz/aspeQual")

## Chargement des packages ----
library(aspe)
library(aspeQual)
library(tidyverse)
library(ggplot2)
library(readxl)

## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")

rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)
```

## Paramètres 

Plusieurs paramètres sont fixés au début de chacun des scripts relatifs à l'étude. Ces paramètres sont modifiables selon les préférences et les objectifs visés. Parmi ces paramètres :

- Les tailles minimum des poissons "adultes" : cf ATTENTION (ci-dessous dans le code)

- Les espèces à retirer du jeu de données : c'est le cas des écrevisses et des espèces hybrides ou mal identifiées (..X) présentes dans notre dataframe. 

- Sélection des passages de pêche à retirer : dans notre étude, les passages 2 et 3 sont retirés. 

- Sélection des types de lots à retirer : dans notre étude, le type de lot "G" n'est pas souhaité.

- Les réseaux de pêches : Il s'agit des types de réseaux sélectionnés. Parmi eux se trouvent le RCS - Réseau de Contrôle de Surveillance ; le RRP - Réseaux de Référence Pérenne ; le RHP - Réseau Hydrobiologique Piscicole ; le RCA - Réseau de contrôle additionnel ; le RCO – Réseau Contrôle opérationnel. Dans notre étude, seul les trois premiers réseaux seront utilisés. Ces réseaux seront tester ensemble puis individuellement afin d'écarter un risque de biais d'objectifs. En effet, les réseaux n'ayant pas les mêmes "objectifs d'observations", un biais peut apparaïtre (ex. le réseaux RPP est un réseau "témoin", qui ne doit pas subir d'influences extérieures, il doit seulement informer des potentiels effets provoqué par le changement climatique). 

- Les types de pêches : Il existe de nombreux types de pêches : pêche partielle par point, pêche par ambiance,.... Ce paramètre permet de sélectionner les types de pêches souhaitées dans l'étude. 


```{r}
## Lire le fichier Excel contenant les tailles à maturité des espèces
traits_biologiques <- read_excel("C:/Users/lea.bouchet/Documents/Artif/Artif/liste_rouge_regionale/scripts/taille_maturite_especes/traits_biologiques.xlsx")

## Selection des tailles de maturité moyenne des espèces : ici les tailles de maturité ne sont pas définitives. Elles ont été calculées à partir de 5 sources différentes (1 et 2 : ouvrages d'identification des poissons d'eau douce de France); 3 : observation des courbes de tailles dans le fichier R "estimation_taille_0+" à partir des données de taille du fichier ASPE ; 4 : les valeurs dans fishbase ; 5 : les valeurs de référence de l'occitanie)


# On conserve seulement les lignes qui nous intéresse : 
traits_biologiques <- traits_biologiques %>% 
  select(esp_code_alternatif,
         espece_presence_lrr_2015,
         taille_maturite_moy)

```


# Constitution du jeu de données

## Création d'un dataframe

Création d'un dataframe contenant les données individuelles relatives aux opérations contenues dans la passerelle et de ma sélection d'espèces (cf 00_selection_pop_ope et 03_analyse_selection_especes).  

```{r}
# Ajout des mesures individuelles en partant de mes ope_selection ----
mei_ope_selection <- passerelle %>%
  mef_ajouter_ope_date() %>% 
  mef_ajouter_mei() %>%
  mef_ajouter_lots() %>% 
  mef_ajouter_type_protocole() %>% 
  mef_ajouter_passage() %>% 
  mef_ajouter_type_lot() %>% 
  mef_ajouter_type_longueur() %>% 
  select(ope_id,
         lop_id,
         lop_effectif,
         esp_code_alternatif,
         mei_id,
         sta_id,
         pop_id,
         mei_taille,
         mei_poids,
         pas_numero,
         tyl_libelle,
         pro_libelle,
         annee,
         tlo_libelle)

# Je dois maintenant sélectionner mes espèces dans mon tableau ope_selection à partir de mon tableau esp_selection (qui ne contient plus les espèces non souhaitées) et aussi avec mon tableau traits biologiques.

lop_esp_selection <- lop_esp_selection %>% 
  left_join(traits_biologiques) %>% 
  filter(espece_presence_lrr_2015 == "1")


# Suppression des passages, des répétitions et des lots non souhaités du jeu de données ----
mei_ope_selection <- mei_ope_selection %>% 
  filter(!pas_numero %in% params$passage_a_retirer,
         pro_libelle %in% params$type_peche_a_inclure,
         !tyl_libelle%in% params$type_lot_a_retirer) %>% 
  distinct() %>% 
  left_join(lop_esp_selection) %>% 
  mutate(lop_esp_code_alternatif = ifelse (test = esp_code_alternatif == "VAN",
                                       yes = "VAR",
                                       no = esp_code_alternatif)) %>% 
  mutate(lop_esp_code_alternatif = ifelse (test = esp_code_alternatif == "CCX",
                                           yes = "CCO",
                                           no = esp_code_alternatif))


# Remplacement des passages = "NA" en "0" (= premier et unique passage) ----
mei_ope_selection <- mei_ope_selection %>% 
  dplyr::mutate(pas_numero = replace_na(pas_numero,0))

#Suppression des "NA" restants ----
mei_ope_selection <- na.omit(mei_ope_selection)

```



## Distinction des classes d'âges

En complément de la base ASPE, un tableau indiquant por chaque espèce la maximale des 0+ est constitué (et donc la taille référence minimum adulte). On utilise donc la longueur du poisson comme proxy de son age.  Une distinction des classes d'âges est réalisée : a chaque espèce correspond alors 3 statuts différents : 
- Adulte (individus dont la taille est supérieure à la taille_min_adulte)
- Juvénile (individus dont la taille est inférieure à la taille_min_adulte)
- Toutes : toute classe d'e taille'âge confondue


```{r}
# Ajout du statut par individus ----
mei_ope_selection <- mei_ope_selection %>% 
  mutate(statut = ifelse(mei_ope_selection$mei_taille < mei_ope_selection$taille_maturite_moy,
                         "juvénile",
                         "adulte"))

```


# Qualité des données tailles / poids

Maintenant que nous avons toutes les données regroupées dans un dataframe général nous pouvons passer à l'aspect qualité des données individuelles des poissons et notamment des valeurs de poids et de tailles. 

```{r}
mon_espece <- "ANG"

esp_lt_data <- mei_ope_selection %>%
  ungroup() %>% 
  filter(tlo_libelle == "Totale",
         esp_code_alternatif == mon_espece)


qtp_histo(df = esp_lt_data,
          code_espece = mon_espece,
          variable = "mei_taille",
          x_max = 500)


seuils1 <- aspeQual::qtp_seuils(
  df = esp_lt_data,
  code_espece = mon_espece,
  variable = "mei_taille",
  seuil_densite = 0.01)

seuils1


library(dplyr)

# Création du DataFrame avec les seuils
df_seuils <- data.frame(
  seuil_min = min(seuils1),
  seuil_max = max(seuils1)
)

# Afficher le DataFrame des seuils
print("DataFrame des seuils :")
print(df_seuils)


```




```{r}
# Filtrer les lignes qui ne respectent pas les seuils
erreur_possible = mei_ope_selection[
    (mei_ope_selection['mei_taille'] < mei_ope_selection['seuil_min']) |
    (mei_ope_selection['mei_taille'] > mei_ope_selection['seuil_max'])
]

# Afficher les résultats
print("Erreurs possibles :")
print(erreur_possible)
```





# Sauvegarde

```{r}
# SAUVEGARDE ----
save(mei_ope_selection,
     file = "../processed_data/pre_traitements_donnees_especes.rda")
```

