---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Application des critères de la liste rouge régionale UICN - sélection des espèces"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne - 
"30_application_criteres_lrr_uicn"


Ce script applique la sélection des espèces à traiter pour le renouvellement de la liste rouge régionale à partir des critères de sélection de l'UICN. Selon la méthodologie de l'UICN, chaque espèce ou sous-espèce peut être classée dans l'une des 11 catégories de la liste rouge en fonction de son risque de disparition de la région considérée. Le classement des espèces dans les catégories d'espèces menacées s'opère sur la base de 5 critères d'évaluation faisant intervenir des facteurs quantitatifs tels que la taille de la population, le taux de déclin, la superficie de l'aire de répartition ou sa fragmentation. 

Il suffit qu'au moins un des critères A à E soit rempli pour qu'une espèce soit classée dans l'une des catégories CR, EN ou VU. 




# Chargement des packages

```{r Chargement des packages}
library(aspe)
library(tidyverse)
library(ggplot2)
library(readxl)
library(dplyr)
library(ggh4x)
```


# Chargement des données

```{r chargement des données}
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
```

# Chargement excel "selection_taxon_lrr"

```{r Chargement Excel}
## Fichier Excel contenant les différentes espèces de la région
reg_espece <- read_excel("../raw_data/selection_taxon_lrr.xlsx")
```

# Chargement des fonctions 

```{r}
source(file = "../R/lrr_critere_a.R")
```



# Principales étapes d'un projet de Liste Rouge Régionale 

La mise en oeuvre d'un projet d'élaboration d'une Liste Rouge Régionale peut se décomposer en ?3 étapes, présentées et réalisées ci-dessous : 


## Identification des espèces soumises au processus d'évaluation : 

1) Etablir la liste des espèces présentes dans la région, sur la base d'un référentiel taxonomique et d'un catalogue régional de référence. Les espèces présentes dans la région sont répertoriées au sein d'un excel et mis dans un dataframe (reg_espece).


2) Identifier dans cette liste les espèces ne devant pas être soumis à l'évaluation, à placer en catégorie "Non Applicable" (NA). A une échelle régionale, certaines espèces ne doivent pas être soumises au processus d'évaluation. Il s'agit des espèces introduites et des espèces erratiques pour lesquelles la méthodologie n'est pas applicable. 

Espèces introduites et indigènes : Il est nécessaire de définir des principes généraux permettant de déterminer la limte entre espèces introduites et espèces indigènes. De manière générale, il est recommandé de considérer les espèces introduites après 1500 comme non indigènes. Toutefois, pour certains groupes taxonomiques, les experts peuvent s'accorder sur d'autres principes analogues si la situation le justifie. 

Espèces erratiques : une espèce est considérée comme erratique lorsque sa présence dans la région est occasionnelle, c'est à dire en général irrégulière et peu fréquente. Pour distinguer les espèces régulièrement présentes des espèces erratiques, il convient de s'accorder sur des principes reposant en particulier sur la fréquence d'observation de l'espèce dans la région. 

Ces dernières sont renseignées sous forme de "NA" dans la colonne "statut_lrr" :

```{r Création statut_lrr}
# Ajout colonne "statut_lrr" pour indiquer les espèces soumises et non soumises au processus d'évaluation
reg_espece$statut_lrr <- ifelse(reg_espece$statut_esp %in% c("introduite", "erratique"), 
                                "NA", 
                                "Applicable")
```



## Phase de pré-évaluation 

1) Réalisation d'une pré-évaluation selon la méthodologie de l'UICN (étapes 1 et 2), afin d'obtenir pour chaque espèce une proposition de catégorie. 


### Etape 1 : évaluation initiale

La première étape consiste à appliquer les critères d'évaluation aux populations situées dans les limites de la région considérée. Cette évaluation initiale aboutit à un classement préliminaire de l'espèce. Comme l'évaluation initiale ne porte que sur la population régionale, le classement déterminé lors de cette première étape peut surestimer (ou parfois sous-estimer) le risque réel de disparition de la région. Un ajustement à la baisse ou à la hausse de la catégorie préliminaire peut donc être nécessaire. 


Cette phase de pré-évaluation se réalise sur les 43 stations étudiées et pré-sélectionnées dans le cadre de ce travail (cf scripts précédents). En effet, les stations sélectionnées sont des stations issues de réseaux (RCS, RHP et RRP) qui se veulent représentatifs (de la biodiversité pour RCS et RRP) de la situation de la Bretagne. Le seul point de vigilience est à porter sur les espèces de grands cours d'eau qui ne sont ici représentés que par 2 stations (La Vilaine). Il s'agira d'un point de vigilence à prendre en compte dans l'analyse des résultats. 



##### Utilisation des critères A à E de l'UICN

---

Temps de génération : La durée d'une génération correspond à l'âge moyen des parents de la cohorte actuelle (c'est à dire des nouveau-nés dans la population). En conséquence, la durée d'une génération reflète le taux de renouvellement des reproducteurs dans une population. La durée d'une génération est plus grande que l'âge à la première reproduction et plus petite que l'âge du reproducteur le plus agé, sauf pour les taxons qui ne se reproduisent qu'une seule fois. Lorsque la durée de la génération varie en raison de mencaes, c'est la durée la plus naturelle, c'est à dire avant perturbation, qu'il convient de retenir (UICN, 2012).


Les temps de génération à prendre en compte pour les différentes espèces sont renseignées dans le tableau de données reg_especes - dans la colonne temps_generation (3 générations ou 10 ans : la plus longue de ces deux données).

---

Catégorie Données Insuffisantes : Lorsque les informations disponibles sont considérées comme insuffisantes pour pouvoir évaluer une espèce, celle-ci est classée dans la catégorie Données insuffisantes (DD) dans l'attente de l'acquisition de nouvelle connaissances. De manière générale, il est souhaitable d'éviter le recours à cette catégorie, dès lors que les informations disponibles permettent d'apprécier raisonnablement la situation de l'espèce. 


Cas de la Bretagne : En Bretagne, 6 espèces indigènes présentes des données insufisantes : 

- Alose feinte : données manquantes; présence côtière, peu ou pas d'observation en eau douce, hybridation possible avec la grande alose;

- Flet : migrateur aux données manquantes; espèce qui n'est pas étudiée et qui l'a été seulement pour caractériser la qualité des estuaires alors qu'elle fait partie de la communauté françaises des poissons diadromes;

- Lamproie fluviatile : manque de données; lamproie de planer et lamproie fluviatile pourraient être deux formes biologiques d'une même espèce (résidente en eau douce et marine);

- Mulet porc : migrateur aux données manquantes; espèce qui n'a été que très peu étudiée  alors qu'elle fait partie de la communauté française des poissons diadromes;

- Tanche : peu de données; espèce très inféodées aux végétaux aquatiques peu représentés dans les potamons bretons (Vilaine - Oust); occurrence de 26 % dans les données CSP-Onema avec une aire de répartition orientale; les analyses statistiques sur le RHP ne montrent pas d'évolutions significatives à l'échelle régionale; cette espèce se reproduit, comme le brochet dans des annexes de la plaine alluviale mais à une période plus tardive au printemps; les conditions de réussite semblent ainsi moins défavorables que pour le brochet;

- Vandoise rostrée :parasitisme laissant supposé un impact sur les populations, mais peu documenté et pas chiffré; le domaine typoloigique de la vandoise est assez réduit en Bretagne (épipotamon et hyporhithron); occurence de 26 % sur réseau de contrôle de surveillance (env 100 stations); les chronologies RHP montrent des résultats très fluctuants (variabilité naturelle des reproduction des cyprinidés ???); cependant on observe des effectifs non négligeables dans des milieux assez dégradés; l'impact du parasitisme a probablement peu de chance de menacer l'espèce à court terme; la menace principale est l'étagement présent en BZH mais depuis longtemps et pas suceptible d'évoluer dans le mauvais sens (tendance plutôt à la suppression de seuils);


Ces espèces sont donc renseignées comme "DD" dans la colonne "statut_lrr" du dataframe :

```{r Mise en place DD}
esp_code_DD <- c("ALF","FLE","MUP", "LPR", "TAN", "VAR")

reg_espece$statut_lrr <- ifelse(reg_espece$esp_code_alternatif %in% esp_code_DD & reg_espece$statut_lrr == "Applicable", "DD", reg_espece$statut_lrr)

```



On réalise maintenant pour chacune des espèces un travail de traitement de données : 

## Critère A : Réduction de la population

Pour utiliser ce critère, il est nécessaire de pouvoir justifier une réduction quantifiée du nombre d'individus matures sur 10 ans ou 3 générations, en retenant la plus longue de ces deux durées (maximum 100 ans). 


```{r Liste espèce à traiter}
# Définir la liste des espèces indigènes à traiter
mes_especes <- reg_espece %>% 
  filter (statut_esp == "indigene",
          statut_lrr == "Applicable") %>% 
  pull(esp_code_alternatif)


# Construction d'u df avec espèce applicable et leurs temps de génération
reg_temps_generation <- reg_espece %>% 
  filter(statut_esp == "indigene",
          statut_lrr == "Applicable") %>% 
  select(esp_code_alternatif,
         temps_generation) %>% 
  na.omit()

```




J'ai avant tout besoin de mettre les valeurs de 0 dans mon tableau de base : 

```{r}
# Création d'un dataframe avec toutes les combinaisons possibles d'années, indicateurs, stades et esp_code_alternatif
combinaisons <- expand.grid(annee = unique(reg_indicateur$annee),
                            indicateur = unique(reg_indicateur$indicateur),
                            stade = unique(reg_indicateur$stade),
                            esp_code_alternatif = unique(reg_indicateur$esp_code_alternatif))

# Fusionner le tableau des combinaisons avec le tableau original en ajoutant des valeurs manquantes avec valeur 0
reg_indicateur_complet <- combinaisons %>%
  left_join(reg_indicateur, by = c("annee", "indicateur", "stade", "esp_code_alternatif")) %>%
  mutate(valeur = ifelse(is.na(valeur), 0, valeur)) %>% 
  select(esp_code_alternatif,
         annee,
         stade,
         indicateur, 
         valeur)

# Maintenant, reg_indicateur_complet contient toutes les combinaisons possibles avec des valeurs de 0 pour celles qui étaient manquantes dans reg_indicateur


reg_indicateur_complet <- reg_indicateur_complet %>%
  left_join(reg_temps_generation, by = "esp_code_alternatif") %>% 
  filter(esp_code_alternatif %in% mes_especes)


```



J'applique une fonction pour le critère A2a (effectif) et A2b (densité surface) : 

```{r}
# Calcul de l'année la plus récente moins le temps de génération pour chaque espèce
reg_indicateur_critere_a <- reg_indicateur_complet %>%
  filter(!stade == "juv") %>% 
  arrange(esp_code_alternatif,
          indicateur,
          stade,
          annee) %>% 
  group_by(esp_code_alternatif) %>%
  mutate(annee_moins_generation = max(annee) - temps_generation) %>%
  ungroup() 


# Calcul des pourcentages d'évolution des valeurs d'indicateurs
reg_indicateur_critere_a <- reg_indicateur_critere_a %>%
  mutate(pourcentage_evo = (valeur - lag(valeur, default = first(valeur))) / lag(valeur, default = first(valeur)) * 100) %>%
  filter(annee == max(annee)) # Sélectionner uniquement les données de l'année la plus récente


# Filtrer uniquement les colonnes nécessaires
reg_indicateur_critere_a <- reg_indicateur_critere_a %>%
  filter(!indicateur == "pourcentage_juveniles",
         !indicateur == "pourcentage_presence_esp")  %>% 
  select(esp_code_alternatif, stade, indicateur, pourcentage_evo)
```

```{r,fig.height = 26, fig.width = 15}
reg_indicateur_critere_a_graph_ind <- reg_indicateur_critere_a %>%
  filter(stade == "ind") %>% 
  ggplot(aes(x = pourcentage_evo, 
             y = esp_code_alternatif, 
             fill = factor(sign(pourcentage_evo)))) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = esp_code_alternatif), 
            position = position_stack(vjust = 1,5), 
            hjust = 0, 
            size = 3.5, 
            color = "black", 
            fontface = "bold") +
  facet_wrap(~ indicateur, scales = "free") +
  labs(title = "Critère A LRR - échelle régionale des espèces de poissons d'eau douce",
       x = "Pourcentage d'évolution", 
       y = "Espèce") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.y = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, vjust = 0.5)) + 
  scale_y_discrete(labels = NULL, breaks = NULL) +
  scale_fill_manual(values = c("#ed0000", "white", "#92D050","white"), 
                     labels = c("Diminution", "","","Augmentation"), 
                     name = "Taux de croissance")

print(reg_indicateur_critere_a_graph_ind)
```


```{r,fig.height = 26, fig.width = 15}

reg_indicateur_critere_a_graph_ad <- reg_indicateur_critere_a %>%
  filter(stade == "ad") %>% 
  ggplot(aes(x = pourcentage_evo, 
             y = esp_code_alternatif, 
             fill = factor(sign(pourcentage_evo)))) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = esp_code_alternatif), 
            position = position_stack(vjust = 1,5), 
            hjust = 0.5, 
            size = 3.5, 
            color = "black", 
            fontface = "bold") +
  facet_wrap(~ indicateur, scales = "free") +
  labs(title = "Critère A LRR - échelle régionale des espèces de poissons d'eau douce",
       x = "Pourcentage d'évolution", 
       y = "Espèce") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.y = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, vjust = 0.5)) + 
  scale_y_discrete(labels = NULL, breaks = NULL) +
  scale_fill_manual(values = c("#ed0000", "white", "#92D050", "white"), 
                     labels = c("Diminution", "","Augmentation", ""), 
                     name = "Taux de croissance")

print(reg_indicateur_critere_a_graph_ad)

```


Application du critère A2a, reposant sur l'observation directe : 
- Critère A2 = Réduction de la population constatée, estimée, déduite ou supposée, dans le passé, lorsque les causes de la réduction n'ont peut être pas cessé OU ne sont peut-être pas comprise ou ne sont peut être pas réversible. 

(a) : l'observation directe => nous sélectionnons alors notre indicateur "effectif_total". 

```{r}
result_A2a_lrr <- reg_indicateur_critere_a %>%
  filter(indicateur == "effectif_total") %>% 
  mutate(statut_espece = case_when(
    pourcentage_evo <= -80 ~ "en danger critique",
    (pourcentage_evo <= -50 & pourcentage_evo > -80) ~ "en danger",
    (pourcentage_evo <= -30 & pourcentage_evo > -50) ~ "vulnérable",
    TRUE ~ "préoccupation mineure"  # Si aucune condition n'est satisfaite, le statut est "préoccupation mineure"
  ))

#Représentation graphique du tableau 
result_A2a_lrr%>%
  DT::datatable(rownames = FALSE)

```
Application du critère A2B, reposant sur un indice d'abondance adapté au taxon (densité de surface) : 
- Critère A2 = Réduction de la population constatée, estimée, déduite ou supposée, dans le passé, lorsque les causes de la réduction n'ont peut être pas cessé OU ne sont peut-être pas comprise ou ne sont peut être pas réversible. 

(b) : indice d'abondance adapté au taxon => densité de surface. 


```{r}
result_A2b_lrr <- reg_indicateur_critere_a %>%
  filter(indicateur == "densite_surface") %>% 
  mutate(statut_espece = case_when(
    pourcentage_evo <= -80 ~ "en danger critique",
    (pourcentage_evo <= -50 & pourcentage_evo > -80) ~ "en danger",
    (pourcentage_evo <= -30 & pourcentage_evo > -50) ~ "vulnérable",
    TRUE ~ "préoccupation mineure"  # Si aucune condition n'est satisfaite, le statut est "préoccupation mineure"
  ))

#Représentation graphique du tableau 
result_A2b_lrr%>%
  DT::datatable(rownames = FALSE)
```

