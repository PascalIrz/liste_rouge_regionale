---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Calcul des indicateurs simples par opérations"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne

Script : 10_calcul_indicateurs_par_ope


Pour rappel, cette étude se divise en plusieurs parties. Dans un premier temps, il s'agit de produire un tableau de bord combinant divers indicateurs simples, à l'échelle de chaque opération de pêche, représentatifs de la dynamique de population des poissons d'eau douce de Bretagne entre 1990 à 2023.

Les pré-traitements nécessaire à la consitution de ce tableau de bord ont été réalisés dans les scripts précédents. Ce script permet donc de constituer les tableaux de bords comportants plusieurs indicateurs dits "simples". Ces indicateurs (densités volumiques, de surface, pourcentages de juvéniles, longueurs médianes,...) seront calculés à l'échelle des opérations de pêches retenues pour l'étude. Ces indicateurs sont calculés par espèces et par stade (juvéniles / adultes), mais également pour l'ensemble des stades (indeterminés). 


# Installation 

## Chargement des packages, fonctions et des données

```{r Chargement des packages}
## Chargement des packages ----
library(tidyverse)
library(aspe)
library(ggplot2)
library(ggthemes)
library(dplyr)
library(readxl)
```

Nous avons donc besoin des jeux de données constitués lors des précédents scripts. 

```{r Chargement des données}
## Chargement des données pré-enregistrées ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
load(file = "../processed_data/pre_traitements_donnees_especes.rda")
```


```{r Chargement des tables ASPE}
#Chargement des tables ASPE ----
rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)
```


```{r Chargement des fonctions}
## Chargement des fonctions ----
source(file = "../R/calcul_biomasse.R")
source(file = "../R/calcul_50_percentile.R")
source(file = "../R/calcul_ecart_interquartile.R")
source(file = "../R/calcul_25_percentile.R")
source(file = "../R/calcul_75_percentile.R")
source(file = "../R/calcul_densite_surface.R")
```



# Les indicateurs par opération de pêche 

## Indicateurs généraux par opération de pêche

Plusieurs indicateurs simples témoignants de la dynamique de populations des poissons d'eau douce sont calculés. 


### Effectif total des espèces par opération de pêche

Les effectifs totaux de chacune des espèces sur chaque opération de pêches (ope_id) sont calculés à partir du jeu de données *mei_ope_selection*. Dans un premier temps, l'ensemble des stades sont gardés. 

```{r Creation tableau effectif total par ope}
ope_effectif <- mei_ope_selection %>%
  group_by(ope_id, esp_code_alternatif) %>%
  distinct(mei_id, .keep_all = TRUE) %>%
  summarise(valeur = n_distinct(mei_id)) %>%
  mutate(indicateur = "effectif_total", stade = "ind") %>%
  select(ope_id, 
         esp_code_alternatif, 
         indicateur, 
         valeur, 
         stade)
```
Dans un second temps, l'indicateur est calculé par stade (juvéniles et adultes). 

```{r Creation tableau effectif total par ope 2}
ope_effectif_stade <- mei_ope_selection %>% 
  group_by(ope_id,
           esp_code_alternatif,
           stade
           ) %>%
  summarise(valeur=length(lop_effectif)) %>% 
  mutate(indicateur= "effectif_total") %>% 
  select(ope_id,
         esp_code_alternatif,
         indicateur,
         valeur,
         stade
         )
```


L'ensemble des effectifs calculés (sans filtrage de stade / juvéniles et adultes) sont regroupés dans un même jeu de données *ope_effectif*. 

```{r Creation tableau effectif total par ope 2}
ope_effectif <- rbind (ope_effectif,ope_effectif_stade) # On regroupe ope_effetif et ope_effectif_stade
```




### Biomasse des espèces par opération de pêche

Les biomasses de chacune des espèces sur chaque opération de pêches (ope_id) sont calculés à partir du jeu de données *mei_ope_selection*. Dans un premier temps, l'ensemble des stades sont gardés. 

```{r Création tableau biomasse totale par ope}
# Calcul de la biomasse par opération  

ope_biomasse <- mei_ope_selection %>%
  group_by(ope_id,
           esp_code_alternatif,
           stade) %>%
  summarise(valeur=sum(poids_tp, na.rm = TRUE)) %>% 
  mutate(indicateur= "biomasse") %>% 
  select(ope_id,
         esp_code_alternatif,
         indicateur,
         valeur,
         stade) 

ope_biomasse <- ope_biomasse %>%
  bind_rows(ope_biomasse %>%
      filter(stade %in% c("ad", "juv")) %>%
      group_by(indicateur, ope_id, esp_code_alternatif) %>%
      summarise(stade = "ind", valeur = sum(valeur)))

```


### Densité surfacique par opération 

```{r Ajout des données de surfaces calculées}
# Ajout des données de surfaces échantillonnées dans mei_esp_ope_selection ----
mei_ope_selection <- mei_ope_selection %>% 
  left_join (y=operation %>% 
               select (ope_id, 
                       ope_surface_calculee,
                       passage$pas_numero))
```

```{r Calcul densités surfaces}
ope_densite_surf <- calcul_densite_surface(mei_ope_selection,
                                           ope_surface_calculee,
                                           ope_id,
                                           esp_code_alternatif,
                                           stade,
                                           mei_id)
```


### Densité volumique par opération

```{r Création df profondeur}
#Ajout des données de profondeurs :
ope_param_profondeur <- ope_selection_param_env %>% 
  filter(parametre == "profondeur") %>% 
  select(ope_id,
         valeur) %>% 
  rename(profondeur=valeur) %>% 
  distinct()
```


```{r Calcul densités volumiques}
densite_surf <- ope_densite_surf %>% 
  rename(valeur_ds = valeur)

ope_densite_vol<- left_join(ope_param_profondeur, densite_surf, by = "ope_id") %>% 
  mutate(valeur = valeur_ds /profondeur) %>%
  ungroup() %>% 
  mutate(indicateur = "densite_volumique") %>% 
  select(ope_id, 
         esp_code_alternatif, 
         indicateur,
         valeur,
         stade)
```


### Pourcentage de juvéniles par opération

```{r Création dataframe pour indicateur pourcentage_juv}
ope_pc_juv <- ope_effectif %>%
  mutate(indicateur = "pourcentage_juveniles")
```


```{r Calcul pourcentage juvéniles}
ope_pc_juv <- ope_pc_juv %>% 
  ungroup() %>% 
  complete(ope_id,
           esp_code_alternatif,
           stade,
           indicateur,
           fill = list(valeur = 0)) %>% 
    group_by(ope_id,
             esp_code_alternatif) %>% 
  mutate(valeur = (valeur [stade == "juv"] / valeur [stade == "ind"])*100) %>% 
  filter(stade == "ind",
         !is.nan(valeur))
```


## Indicateurs sur les mesures individuelles par opération de pêche

### Longueur médiane

Calcul des longueurs médianes des tailles des individus par opération : Création de la fonction "calcul_50_percentile" : 

```{r Calcul longueur médiane mei}
ope_lm <- calcul_50_percentile(mei_ope_selection,
                               mei_taille,
                               ope_id,
                               esp_code_alternatif, 
                               stade)
```


### Ecart interquartile

Calcul des écarts interquartiles des tailles des individus par opération : Création de la fonction "calcul_ecart_interquartile" : 

```{r Calcul Ecart interquartile longueurs médianes}
ope_ecart_inter <- calcul_ecart_inter(mei_ope_selection,
                                      mei_taille,
                                      ope_id,
                                      esp_code_alternatif, 
                                      stade)
```


### Percentiles 25 et 75  pour les longueurs médianes

Calcul des percentiles 25 et 75 des tailles des individus par opération : Création de la fonction "calcul_25_percentile" et "calcul_75_percentile" : 

```{r Calcul p25 longueurs médianes}
ope_p25 <- calcul_p25(mei_ope_selection,
                      mei_taille,
                      ope_id,
                      esp_code_alternatif, 
                      stade)
```


```{r Calcul p75 longueurs médianes}
ope_p75 <- calcul_p75(mei_ope_selection,
                      mei_taille,
                      ope_id,
                      esp_code_alternatif, 
                      stade)
```


# Echelle régionale (pre-données)

On calcul le pourcentage des sites prospectés où l'espèce a été trouvée :

```{r Calcul pourcentage présence especes}

ope_biomasse1 <- ope_biomasse %>% 
  filter (stade == "ind")

combinaisons <- expand.grid(esp_code_alternatif = unique(ope_biomasse1$esp_code_alternatif),
                            ope_id = unique(ope_biomasse$ope_id))

# Fusionner les combinaisons avec le dataframe initial
reg_pc_site_presence_esp <- combinaisons %>%
  left_join(ope_biomasse1, by = c("esp_code_alternatif", "ope_id")) %>%
  mutate(present = !is.na(indicateur)) %>%
  group_by(esp_code_alternatif) %>%
  mutate(
    stade = "ind",
    indicateur = "pourcentage_site_presence_esp",
    valeur = sum(present) / n_distinct(ope_id) * 100
  ) %>%
  select(-present)

# Affichage du résultat
print(reg_pc_site_presence_esp)
```


# Création du tableau final empilé des indicateurs

L'ensemble des indicateurs calculés sont regroupés dans le dataframe *ope_indicateur*. 

```{r Création df final "ope_indicateur"}
# Création du tableau pré-final avec tous les indicateurs calculés
ope_indicateur <- rbind(ope_lm,
                        ope_densite_surf,
                        ope_densite_vol,
                        ope_pc_juv,
                        ope_biomasse,
                        ope_effectif,
                        reg_pc_site_presence_esp)
```

Les années d'opérations ainsi que les identifiant des point de prélèvements sont ajoutés au tableau *ope_indicateur*. 

```{r Ajout données année et pop_id}
# Ajout des années d'opération au site et à l'année (pop_id) et (ope_date)
ope_indicateur <- ope_indicateur %>% 
  ungroup() %>%   
  left_join(y=operation %>% 
              select(ope_id,
                     pop_id= ope_pop_id,
                     ope_date)) %>% 
  mef_ajouter_ope_date() %>% 
    select(ope_id,
           esp_code_alternatif,
           indicateur,
           valeur,
           stade,
           pop_id,
           annee)
```

Nous visualisons le dataframe final *ope_indicateur* regroupant donc l'ensemble des indicateurs calculés (par espèces / opérations et stades). Il s'agit de notre tableau de bord final à l'échelle des opérations. 

```{r Visualisation tableau "ope_indicateur"}
#Représentation graphique du tableau 
ope_indicateur%>%
  DT::datatable(rownames = FALSE)
```


# Sauvegarde

```{r Sauvegarde}
# SAUVEGARDE ----
save(ope_indicateur,
     mei_ope_selection,
     file = "../processed_data/assemblage_tab_par_ope.rda")
```
