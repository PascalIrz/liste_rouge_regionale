---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Modèles Linéaires Généralisés à effet mixte"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne

Script : 13_GLMM

Ce script a pour objectif d'evaluer l'impact qu'ont les différents réseaux sur les tendances des indicateurs régionaux. Il a également l'objectif de regarder l'impact des changements de protocoles sur les stations au cours des années d'études grâce aux modèles linéaires généralisés à effets mixtes. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library(dplyr)
library(lme4)
library(lmerTest)
library(car)
library(flextable)
library(purrr)
library(broom)
library(ggstats)
library(parameters)
library(ggstatsplot)
```

```{r Chargement des tables ASPE }
## Chargement des tables ASPE ----
rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)

```

```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/analyse_indicateurs_regionaux_pour_mk_glm.rda")

```

```{r Chargement des fonctions}

source(file = "../R/glm_calcul_modele.R")
source(file = "../R/glm_application_modele.R")
source(file = "../R/lm_application_modele.R")
source(file = "../R/lm_calcul_modele.R")

```


# Modèles Linéaires Généralisés à effets mixtes (GLMM)

## Introduction

Les modèles linéaires généralisés à effets mixtes combinent les caractéristiques des modèles linéaires généralisés (modéliser des variables non-normalement distribuées, spécialement des données binaires et de comptage) et des modèles à effets mixtes (modéliser des données groupées).


Nous utiliserons dans cette étude le package *lme4* pour ajuster des modèles mixtes. La fonction *lmer* de ce package estime les paramètres d’un modèle linéaire mixte. Les formules utilisées par *lmer* suivent la forme *reponse ~ predicteurs*, avec une syntaxe spécifique pour les effets aléatoires.


## Modèles linéaires mixtes dans R 

Dans notre étude, *pop_id* est la variable contenant les identifiants des groupes dans le jeu de données *ope_indicateur_glmm_ex*. Le terme (1 + obj_libelle | pop_id ) indique de modéliser un effet aléatoire du groupe *pop_id* pour l’ordonnée à l’origine (codée “1”) et le coefficient de *obj_libelle*. Si seule l’ordonnée à l’origine variait par groupe, donc si la pente de *valeur* vs. *obj_libelle* était fixée à une seule valeur pour tous les groupes, on pourrait écrire (1 | *pop_id*). *pro_libelle* est un prédicteur définis au niveau du groupe, il apparait donc dans la formule comme n'importe quel autre prédicteur.


## Modèles linéaires généralisés à effets mixtes

Les modèles linéaires généralisés à effets mixtes (abbréviés GLMM, pour generalized linear mixed models) combinent les caractéristiques de deux types de modèles : les modèles linéaires généralisés et les modèles linéaires mixtes.


Le package *lme4* contient une fonction *glmer* pour estimer les paramètres d’un GLMM. Celle-ci est semblable à *lmer*, excepté qu’on spécifie la distribution non-normale de la réponse par le biais du paramètre *family*.






# Pré-traitement 

Afin d'appliquer les modèles GLMM, il est nécessaire de construire un jeu de données contenant les valeurs des indicateurs, les espèces, les stades, les *pop_id*, mais aussi les types de réseaux et les protocoles de pêches. Nous utilisons dans un premier temps, le jeu de données relatifs aux opérations de pêches (*ope_indicateur*) car nous souhaitons observer les effets des réseaux et des protocoles sur les résultats à l'opération. 


```{r Création dataframe ope_indicateur_glm}
# Création d'un df complet pour l'application des modèles GLM
ope_indicateur_glm <- ope_indicateur %>%
  filter(indicateur%in% c("biomasse","densite_surface","effectif_total","pourcentage_juveniles")) %>% # Sélection des indicateurs à étudier
  rename(espece = esp_code_alternatif) %>%
  mef_ajouter_objectif() %>%
  mef_ajouter_type_protocole() %>% 
  filter (!obj_libelle == "DCE – Référence") %>% 
  select(-obj_id)  

ope_indicateur_glm <- ope_indicateur_glm %>% # On s'assure que pop_id est bien en factor
  mutate(pop_id = as.factor(pop_id)) %>%
  filter(espece %in% c("ANG","BRO", "CHA", "CHE","PER", "GAR", "GOU", "LOF", "LPP","SAT", "TRF", "VAI", "VAR")) # Sélection des espèces étudiées pour la révision de la LRR

```


Avant de lancer le modèle, il est important de définir la liste des périodes d'études souhaités. Dans le cadre de notre étude, nous souhaitons étudier les différentes périodes d'études imposés par la méthodologie liste rouge (spécifique à chaque espèces) ; ainsi nous distinguons 5 périodes d'études distinctes : 

```{r Etablir les périodes d'études GLM}
liste_periodes_etude <- list(c(2008, 2023), 
                             c(2005, 2023),
                             c(1990, 2023),
                             c(2011,2023),
                             c(2013,2023)) # Liste des périodes (chaque période est un vecteur avec l'année de début et l'année de fin)

```



# Application modèles GLM 

## Echelle ope_indicateur

Afin d'excéuter l'analyse, deux fonctions ont été créer : *glm_calcul_modele* (en charge de calculer les valeurs des modèles GLM) et *glm_application_modele* (le but étant d'excécuter la fonction *glm_calcul_modele* pour l'ensemble des combinaisons *periodes-especes-stade-indicateur*). Il est donc nécessaire de charger, dans la partie II d'installation, les deux fonctions. 

```{r Excecution fonctions GLM}
glm_resultats <- glm_application_modele(data = ope_indicateur_glm,
                                        liste_periodes = liste_periodes_etude)
```



Les résultats de la fonction apparaissent dans le dataframe *glm_resultats*. Les résultats significatifs sont ensuite renvoyés dans un nouveau dataframe *glm_resultats_signif*. 

```{r Résultats fonctions GLM}
glm_resultats_signif <- glm_resultats %>% # Création d'un dataframe avec l'ensemble des résultats significatifs
  filter(sig %in% c("***","**","*"))
```



Nous réalisons maintenant une représentation graphiques de ces résultats 

```{r}
# glm_resultats %>% 
#   filter(esp_code_alternatif == "GAR",
#          indicateur == "biomasse",
#          stade == "ind") %>% 
#   ggcoef_model(glm_resultats, exponentiate = TRUE, intercept = TRUE)

```




#### Je souhaite applqiuer les analyses GLM pour mon choix d'espèces / stades / Indicateurs : 

### Tri des espèces
On ne retient qeue les espcèes pour lesquelles nous avons un fort intérêt (au vu des premières tendances dégagées et dans l'optique de la réactualisation de la LRR). 

```{r Tri espèces}
ope_indicateur_reduit <- ope_indicateur %>% 
  filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR"))
```


## Tri dans les indicateurs
On ne retient que les indicateurs les plus pertinents à l'analyse des tendances pour glm.

```{r Tri indicateurs}
ope_indicateur_reduit <- ope_indicateur_reduit %>% 
filter(!indicateur %in% c("pourcentage_site_presence_esp",
                          "longueur_mediane",
                          "densite_volumique",
                          "effectif_total",
                          "biomasse")) %>% 
  filter(!(indicateur == "densite_surface" & esp_code_alternatif == "VAI" & stade == "ad" & valeur > 0.08)) # On enlève une valeur abérante qui fausse le graphique

```


On réalise un pré-traitement dans les données de notre ope_indicateur : sélection que des stades adultes pour toutes les espèces sauf "ind" pour la LPP et le SAT. 

```{r}
# Filtrer les lignes avec stade == "ad" sauf pour LPP et SAT
filtered_ad_ope <- ope_indicateur_reduit %>%
  filter(stade == "ad" & !esp_code_alternatif %in% c("LPP", "SAT"))

# Filtrer les lignes avec stade == "ind" pour LPP et SAT, ainsi que pour les indicateurs spécifiques
filtered_ind_ope <- ope_indicateur_reduit %>%
  filter(stade == "ind" & 
         (esp_code_alternatif %in% c("LPP", "SAT") | 
          indicateur %in% c("pourcentage_juveniles")))

# Combiner les deux dataframes
ope_indicateur_tri_final_tendances_LRR <- bind_rows(filtered_ad_ope, filtered_ind_ope)


ope_indicateur_tri_final_tendances_LRR <- ope_indicateur_tri_final_tendances_LRR %>%
  rename(espece = esp_code_alternatif) %>%
  mef_ajouter_objectif() %>%
  mef_ajouter_type_protocole() %>% 
  filter (!obj_libelle == "DCE – Référence") %>% 
  select(-obj_id)

```


On applique les modèles GLM (sur toutes les périodes pour tout le monde tant pis)
```{r Excecution fonctions GLM}
glm_resultats_LRR <- glm_application_modele(data = ope_indicateur_tri_final_tendances_LRR,
                                        liste_periodes = liste_periodes_etude)
```



Les résultats de la fonction apparaissent dans le dataframe *glm_resultats*. Les résultats significatifs sont ensuite renvoyés dans un nouveau dataframe *glm_resultats_signif*. 

```{r Résultats fonctions GLM}
glm_resultats_LRR_signif <- glm_resultats_LRR %>% # Création d'un dataframe avec l'ensemble des résultats significatifs
  filter(sig %in% c("***","**","*"))
```


Explications - https://pmarchand1.github.io/ECL8202/notes_cours/05-Modeles_generalises_mixtes.html 

# Sauvegarde

```{r}
save(glm_lm_resultats,
     glm_resultats_LRR,
     file = "../processed_data/glm_lm_tendances.rda")
```

