---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Calcul des indicateurs régionaux"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne
11_calcul_indicateurs_regionaux

Pour les indicateurs calculés au point, on agrège chaque année leur valeur à l'échelle régionale. Le taux d'occurence de chaque espèce est directement calculée annuellement, à l'échelle régionale, comme le pourcentage de sites prospectés où l'espèce a été trouvée. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library (khroma)
library(dplyr)
library(wesanderson)
library(zoo)
library(gt)
library(lemon)
library(trend)
library(ggh4x)
library(purrr)
library(broom)
library(ggforce)
```


```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
```


```{r Chargement des fonctions}
source(file = "../R/mk_st_by_group.R")
source(file = "../R/mann_kendall_sen.R")
source(file = "../R/calcul_taux_evolution.R")
source(file = "../R/calcul_glm.R")
```


```{r Chargement de la palette de couleur}
# Définition des couleurs de l'OFB en format RGB
pal <- c("#007844", "#92D050", "#0087C1", "#FCEE21", "#00AEEF", "#1D1D1B", "#A97B30", "#B9D9EB")
```


# Constitution du jeu de données

## Taux d'occurrence

On calcul le taux d'occurrence des espèces : 

```{r Calcul taux occurrence}
occur <- ope_indicateur %>% 
  filter(stade == "ind",
         indicateur == "effectif_total",
         valeur > 0) %>%
  group_by(annee, esp_code_alternatif) %>% 
  summarise(n_occur = n_distinct(ope_id))

n_ope_par_an <- ope_indicateur %>% 
  filter(stade == "ind",
         indicateur == "effectif_total") %>%
  group_by(annee) %>% 
  summarise(n_ope = n_distinct(ope_id))

taux_occ <- occur %>% 
  left_join(n_ope_par_an) %>% 
  mutate(valeur = n_occur / n_ope,
         indicateur = "taux_occurrence",
         stade = "ind")
```


# Regroupement des indicateurs à l'Echelle régionale

```{r Construction tab reg_indicateur, fig.height = 55, fig.width = 10}
# Calcul des données par année et pop_id en calculant la médiane de la valeur de l'indicateur ----
reg_indicateur <- ope_indicateur %>%
  group_by(esp_code_alternatif, 
           annee, 
           indicateur, 
           stade) %>%
  summarize(valeur = case_when(
    indicateur == "pourcentage_juveniles" ~ mean(valeur),
    TRUE ~ median(valeur)
  )) %>%
  ungroup() %>%
  distinct()
```


```{r Construction tab reg_indicateur part 2}
taux_occ <- taux_occ %>% 
  select(names(reg_indicateur))

reg_indicateur <- reg_indicateur %>% 
  rbind(taux_occ) %>% 
  filter(!indicateur %in% c("pourcentage_site_presence_esp",
                          "longueur_mediane",
                          "densite_volumique"))

```


## Tri des espèces LRR

```{r Representation graphique des données}
reg_indicateur <- reg_indicateur %>% 
  filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR"))
```



## Significativité des indicateurs

```{r}
# Fonction pour effectuer les régressions linéaires et extraire les p-values
get_pvalues <- function(data, start_year, end_year) {
  data_filtered <- data %>% filter(annee >= start_year & annee <= end_year)
  results <- data_filtered %>%
    group_by(stade, indicateur, esp_code_alternatif) %>%
    do(tidy(lm(valeur ~ annee, data = .)))
  results %>% filter(term == "annee") %>% select(stade, indicateur, esp_code_alternatif, p.value)
}

pvalues_2010_2023 <- get_pvalues(reg_indicateur, 2010, 2023)
pvalues_2000_2013 <- get_pvalues(reg_indicateur, 2000, 2013)
```


```{r, fig.height = 26, fig.width = 10}
# Ajouter la colonne de signification
pvalues_2010_2023 <- pvalues_2010_2023 %>%
  mutate(significance = ifelse(p.value < 0.05, "significant", "non_significant"))

pvalues_2000_2013 <- pvalues_2000_2013 %>%
  mutate(significance = ifelse(p.value < 0.05, "significant", "non_significant"))

# Joindre les p-values aux données d'origine
reg_indicateur <- reg_indicateur %>%
  left_join(pvalues_2010_2023 %>% select(-p.value), by = c("stade", "indicateur", "esp_code_alternatif")) %>%
  left_join(pvalues_2000_2013 %>% select(-p.value), by = c("stade", "indicateur", "esp_code_alternatif"), suffix = c("_2010_2023", "_2000_2013"))
```


Je souhaite éliminer une donnée abérantes qui perturbe ma représentation graphique :

```{r}

# Filtrer les données en conservant celles qui ne répondent pas aux critères
reg_indicateur <- reg_indicateur %>%
  filter(!(indicateur == "densite_surface" & esp_code_alternatif == "VAI" & valeur > 0.08))

```


# Représentation graphique des tendances démographiques : 

```{r, fig.height = 26, fig.width = 10}
# Créer le graphique
reg_indicateur_graph <- reg_indicateur %>%
  ggplot(aes(x = annee, y = valeur, group = stade, color = stade)) +
  geom_point(shape = 1) +
  facet_grid2(esp_code_alternatif ~ indicateur, scales = "free", independent = "y") +
  scale_color_manual(values = c("juv" = "#92D080", "ad" = "#A97B30", "ind" = "black"),
                     name = "Stade", labels = c("Adulte", "Indifférencié", "Juvénile")) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.x = element_text(angle = 45))

# Ajouter les lignes de régression avec des styles différents selon la signification
reg_indicateur_graph <- reg_indicateur_graph +
  geom_smooth(data = reg_indicateur %>% filter(annee %in% 2010:2023, significance_2010_2023 == "significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "solid") +
  geom_smooth(data = reg_indicateur %>% filter(annee %in% 2010:2023, significance_2010_2023 == "non_significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "dashed") +
  geom_smooth(data = reg_indicateur %>% filter(annee %in% 2000:2013, significance_2000_2013 == "significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "solid") +
  geom_smooth(data = reg_indicateur %>% filter(annee %in% 2000:2013, significance_2000_2013 == "non_significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "dashed")

print(reg_indicateur_graph)

```


Cette représentation graphique est à priori trop compliquée et peu lisible (avec en plus des droites qui influencent beaucoup l'interprétation). Le fait qu'il y ai plusieurs stades peu biaiser la comprehension. On produit donc un graphique qu'avec les données d'adultes  : 


```{r, fig.height = 26, fig.width = 10}
reg_indicateur_graph_2 <- reg_indicateur %>%
  filter((indicateur == "densite_surface" & stade == "ad") |
    (indicateur == "pourcentage_juveniles" & stade == "ind") |
    (indicateur == "taux_occurrence" & stade == "ind")) %>% 
  ggplot(aes(x = annee, 
             y = valeur, 
             group = stade, 
             color = indicateur)) +
  geom_point(shape = 1) +
  geom_smooth(method = "loess", se = FALSE) +  # Ajout des courbes de tendance loess
  facet_grid2(esp_code_alternatif ~ indicateur, scales = "free", independent = "y") +
  scale_color_manual(values = c("densite_surface" = "#A97B30", "taux_occurrence" = "black", "pourcentage_juveniles" = "#92D080" ),
                     name = "Stade", labels = c("Adulte")) +
  #scale_y_continuous(breaks = seq(0, max(reg_indicateur$valeur, na.rm = TRUE), by = 5)) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.x = element_text(angle = 45)) +
  geom_vline(xintercept = 2010, linetype = "dashed", color = "red")

print(reg_indicateur_graph_2)

```












## Tendances globales 

Il s'agit d'observer les différentes tendances présentes sur les indicateurs précedement établis. 


```{r Fonction mk_st_by_group, fig.height = 25, fig.width = 10}
tendance_indicateur <- mk_st_by_group(ope_indicateur,
                                      var_x = annee,
                                      var_y = valeur,
                                      esp_code_alternatif,
                                      indicateur,
                                      stade, 
                                      pop_id)
```



```{r Représentation graphique tendance_indicateur ad, fig.height = 25, fig.width = 10}
tendance_indicateur %>%
    filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR")) %>% 
  filter(indicateur!="taux_occurrence",
         stade == "ad") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur, 
              scales = "free") +
  labs(title = "Tendances indicateurs - Adulte", 
       x = "Tendance", 
       y = "Valeurs pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        legend.position = "bottom") 
```



```{r Représentation graphique tendance_indicateur juv, fig.height = 25, fig.width = 10}
tendance_indicateur %>% 
    filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR")) %>% 
  filter(indicateur!="taux_occurrence",
         stade == "juv") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur  , 
              scales = "free") +
  labs(title = "Tendances indicateurs - Juvénile", 
       x = "Tendance", 
       y = "Valeur pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        legend.position = "bottom") 

```


```{r Représentation graphique tendance_indicateur ind, fig.height = 25, fig.width = 10}
tendance_indicateur %>% 
    filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR")) %>% 
  filter(indicateur!="taux_occurrence",
         indicateur!="pourcentage_site_presence_esp",
         stade == "ind") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur  , 
              scales = "free") +
  labs(title = "Tendances indicateurs - Indifférencié", 
       x = "Tendance", 
       y = "Valeur pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        axis.text.x = element_text(angle = 45),
        legend.position = "bottom") 
```


## Taux d'Evolution

On souhaite calculer le taux d'évolution inter-annuel, c'est à dire entre l'année n et l'année n-1, par espèce. Si le taux d'évolution est positif, cela correspond à une croissance de la population ; si il est négatif, cela correspond à un déclin. 

```{r Calcul des taux evolution}
# Calcul des taux d'évolution depuis 1990

taux_evol_1990 <- calcul_taux_evol(df = reg_indicateur,
                             var_x = annee,
                             var_y = valeur,
                             debut = 1990,
                             esp_code_alternatif,
                             stade,
                             indicateur)
print(taux_evol_1990)

```



```{r Définition des seuils et couleurs taux evol, fig.height = 25, fig.width = 10}
# Définition des seuils et des couleurs correspondantes
seuils <- c(0.55, 0.99, 1.01, 1.25)
couleurs <- c("#CB2027", "#DDDDDD","#8fd175")
n <- length(seuils)
```


```{r Représentation graphique taux evol, fig.height = 25, fig.width = 10}
# Représentation graphique :
taux_evol_graph <- taux_evol_1990 %>%
  ggplot(aes(x = reorder(stade, mean_geom), y = mean_geom, color = stade)) +
  geom_point(shape = 19) +
  geom_line(aes(group = stade)) +
  facet_grid(~ esp_code_alternatif ~ indicateur, scales = "free") +
  labs(title = "Taux évolution", x = "Stade", y = "Moyenne Géométrique") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color = "#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill = "#faf0e0"),
        legend.position = "bottom") + 
  scale_color_manual(values = c("juv" = "#92D080", "ad" = "#A97B30", "ind" = "black"),
                     name = "Stade", labels = c("Adulte", "Indifférencié", "Juvénile"))


 for (i in 1:(n-1)) {
   taux_evol_graph <- taux_evol_graph +
     annotate("rect", xmin = -Inf, xmax = Inf, ymin = seuils[i], ymax = seuils[i+1], fill = couleurs[i], alpha = 0.1)
 }

print(taux_evol_graph)

```




### Vérification des taux d'évolutions obtenus 

On souhaite ici avoir une vérification de la cohérence des données obtenues sur les taux d'évolution, on souhaite alors regarder les taux d'évolution sur un paramètres particulier : les effectifs. 

```{r Pré traitement des données testées pour vérif taux évolution 1990}
# Sélection de l'indicateur souhaité pour la vérification
indicateur_sel <- "effectif_total"

# On regarde les taux d'évolution seulement pour le stade "indiférencié"
taux_evol_eff <- taux_evol_1990 %>% 
  filter (indicateur == indicateur_sel,
          stade == "ind")
```


```{r Pré traitemenent part 2}
tendance_indicateur_eff <- tendance_indicateur %>% 
  filter (indicateur == indicateur_sel,
          stade == "ind") %>% 
  select(-pop_id) %>% 
  group_by(esp_code_alternatif) %>% 
  mutate(med_Sen = median(sens_slope))
```


```{r Construction final du tableau tendance_indicateur_eff pour la vérif}
tendance_indicateur_eff <- tendance_indicateur_eff %>% 
  left_join(taux_evol_eff) %>% 
  select (esp_code_alternatif,
          mean_geom,
          med_Sen) %>% 
  unique()
```


Observation de ce qu'il se passe au niveau des taux d'évolution : On s'attend, sur le graphique produit, à avoir les données d'espèces d'aligner sur une droite : 

```{r}
tendance_indicateur_gra <- tendance_indicateur_eff %>% 
  filter(!esp_code_alternatif %in% c("FLE", "MUP", "PLI", "LPR", "ALF" )) %>%  # On retire les espèces qui ont trop peu de données pour être évaluées
  ggplot(aes(x = mean_geom, y = med_Sen,  label = esp_code_alternatif)) +
  geom_smooth(method = "lm", se = TRUE) + 
  geom_point() + 
  geom_hline(yintercept = 0,
             linetype = "dotted") +
  geom_vline(xintercept = 1,
             linetype = "dotted") +
  ggrepel::geom_text_repel()
 
print(tendance_indicateur_gra)
```



# Sauvegarde : 

```{r Sauvegarde}
# SAUVEGARDE ----
save(taux_occ,
     reg_indicateur,
     taux_evol_1990,
     ope_indicateur,
     file = "../processed_data/calcul_indicateurs_regionaux.rda")
```
