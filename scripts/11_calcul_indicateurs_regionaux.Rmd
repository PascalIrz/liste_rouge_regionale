---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Calcul des indicateurs régionaux"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne - 11_calcul_indicateurs_regionaux

Pour les indicateurs calculés au point, on agrège chaque année leur valeur à l'échelle régionale. Le taux d'occurence de chaque espèce est directement calculée annuellement, à l'échelle régionale, comme le pourcentage de sites prospectés où l'espèce a été trouvée. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r}

## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library (khroma)
library(dplyr)
library(wesanderson)
library(zoo)
library(lemon)
library(trend)
library(ggh4x)


## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")

# rdata_tables <- misc_nom_dernier_fichier(
#   repertoire = "../../../../projets/ASPE/raw_data/rdata",
#   pattern = "^tables")
# load(rdata_tables)

source(file = "../R/mk_st_by_group.R")
source(file = "../R/mann_kendall_sen.R")
source(file = "../R/calcul_taux_evolution.R")
source(file = "../R/calcul_pourcentage_presence_station.R")

# Définition des couleurs de l'OFB en format RGB
pal <- c("#007844", "#92D050", "#0087C1", "#FCEE21", "#00AEEF", "#1D1D1B", "#A97B30", "#B9D9EB")
```


# Constitution du jeu de données


### Taux d'occurrence

On calcul le taux d'occurrence des espèces : 

```{r}
occur <- ope_indicateur %>% 
  filter(statut == "toutes",
         indicateur == "effectif_total",
         valeur > 0) %>%
  group_by(annee, esp_code_alternatif) %>% 
  summarise(n_occur = n_distinct(ope_id))

n_ope_par_an <- ope_indicateur %>% 
  filter(statut == "toutes",
         indicateur == "effectif_total") %>%
  group_by(annee) %>% 
  summarise(n_ope = n_distinct(ope_id))

taux_occ <- occur %>% 
  left_join(n_ope_par_an) %>% 
  mutate(valeur = n_occur / n_ope,
         indicateur = "taux_occurrence",
         statut = "toutes")
```



```{r}
# ope_id <- unique(ope_indicateur$ope_id)
# esp_code_alternatif <- unique(ope_indicateur$esp_code_alternatif)
# statut <- unique(ope_indicateur$statut)
# 
# annees <- ope_indicateur %>% 
#   ungroup() %>% 
#   select(ope_id,
#          annee) %>% 
#   distinct()
# 
# tab_oc <- crossing(ope_id, esp_code_alternatif, statut) 
# 
# densites_surface <- ope_indicateur %>% 
#   filter(indicateur == "densite_surface") 
# 
# taux_occurrence_densite_surface <- tab_oc %>% 
#  # left_join(densites_surface) %>% 
#   mutate(valeur = ifelse(is.na(valeur), 0, valeur)) %>% 
#   select(-indicateur,
#          -annee,
#          -pop_id) %>% 
#   left_join(annees) %>% 
#   group_by(esp_code_alternatif,
#            statut,
#            annee) %>% 
#   summarise(n_ope = n_distinct(ope_id),
#             n_oc = n_distinct(ope_id[valeur > 0]),
#             taux_oc = n_oc / n_ope) %>% 
#   mutate(indicateur = "taux_occurrence",
#          valeur = taux_oc) %>% 
#   select(-n_ope,
#          -n_oc,
#          -taux_oc)

```


## Echelle régionale

```{r, fig.height = 55, fig.width = 10}
# Calcul des données par année et pop_id en calculant la médiane de la valeur de l'indicateur ----
reg_indicateur <- ope_indicateur %>%
  group_by(esp_code_alternatif, annee, indicateur, statut) %>%
  summarize(valeur = case_when(
    indicateur == "pourcentage_juveniles" ~ mean(valeur),
    TRUE ~ median(valeur)
  )) %>%
  ungroup() %>%
  distinct()
```

```{r}
taux_occ <- taux_occ %>% 
  select(names(reg_indicateur))

reg_indicateur <- reg_indicateur %>% 
  rbind(taux_occ)

ope_indicateur <- ope_indicateur %>% 
  rbind(taux_occ)
```

```{r, fig.height = 55, fig.width = 10}
# Représentation graphique des données : 
graphique <- reg_indicateur %>% 
  ggplot(aes(x= annee, y =valeur, group = statut, color = statut)) + 
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_grid2(esp_code_alternatif ~ indicateur, scales = "free", independent = "y") + 
  scale_color_manual(values= pal) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs")
print(graphique)

```


## Tendances globales 

Il s'agit d'observer les différentes tendances présentes sur les indicateurs précedement établis. 

```{r}
```



```{r, fig.height = 25, fig.width = 10}
tendance_indicateur <- mk_st_by_group(ope_indicateur,
                                      var_x = annee,
                                      var_y = valeur,
                                      esp_code_alternatif,
                                      indicateur,
                                      statut, 
                                      pop_id)


tendance_indicateur %>% 
  filter(indicateur!="taux_occurrence") %>% 
  group_by(indicateur,
           trend,
           statut,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid( ~ statut ~ indicateur ~ esp_code_alternatif, 
              scales = "free") +
  labs(title = "Tendances indicateurs", 
       x = "Trend", 
       y = "Valeurs") +
  theme_bw() +
  scale_color_manual(values = pal)
```


### Taux d'Evolution

On souhaite calculer le taux d'évolution inter-annuel, c'est à dire entre l'année n et l'année n-1, par espèce. Si le taux d'évolution est positif, cela correspond à une croissance de la population ; si il est négatif, cela correspond à un déclin. 

```{r}
# Taux d'évolution du taux d'occurence de densité de surface : 
# FONCTION : 

calcul_taux_evol_oc_densite_surface <-
  calcul_taux_evolution(df = taux_occ,
                        var_annee = annee,
                        var_statut = statut,
                        var_esp_code_alternatif = esp_code_alternatif,
                        var_valeur = valeur)

# Représentation graphique :
ggplot(calcul_taux_evol_oc_densite_surface, aes(x = annee)) +
  geom_line(aes(y = Taux_evol_ANG, color = "ANG")) +
  geom_line(aes(y = Taux_evol_ABL, color = "ABL")) +
  geom_line(aes(y = Taux_evol_BRE, color = "BRE")) +
  # Ajoutez d'autres lignes pour chaque espèce souhaitées
  labs(title = "Évolution des taux d'évolution de la densité de surface par espèce",
       x = "Année",
       y = "Taux d'évolution") +
  theme_minimal() +
  scale_color_manual(values= pal)

```




## Pourcentage de station_esp

On cherche à calculer le pourcentage des stations pour laquelle une espèce est présente pour une année donnée


```{r}
#ATTENTION !!! La fonction ne marche pas ... 
#calcul_pourcentage_presence_station <- calcul_pourcentage_presence_station(pop_indicateur,
#                                                                           esp_code_alternatif,
#                                                                           statut,
#                                                                           pop_id,
#                                                                           annee)
```

