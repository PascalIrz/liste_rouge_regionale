---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Calcul des indicateurs régionaux"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne
11_calcul_indicateurs_regionaux

Pour les indicateurs calculés au point, on agrège chaque année leur valeur à l'échelle régionale. Le taux d'occurence de chaque espèce est directement calculée annuellement, à l'échelle régionale, comme le pourcentage de sites prospectés où l'espèce a été trouvée. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library (khroma)
library(dplyr)
library(wesanderson)
library(zoo)
library(gt)
library(lemon)
library(trend)
library(ggh4x)
library(purrr)
```


```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
```


```{r Chargement des fonctions}
source(file = "../R/mk_st_by_group.R")
source(file = "../R/mann_kendall_sen.R")
source(file = "../R/calcul_taux_evolution.R")
source(file = "../R/calcul_glm.R")
```


```{r Chargement de la palette de couleur}
# Définition des couleurs de l'OFB en format RGB
pal <- c("#007844", "#92D050", "#0087C1", "#FCEE21", "#00AEEF", "#1D1D1B", "#A97B30", "#B9D9EB")
```


# Constitution du jeu de données

## Taux d'occurrence

On calcul le taux d'occurrence des espèces : 

```{r Calcul taux occurrence}
occur <- ope_indicateur %>% 
  filter(stade == "ind",
         indicateur == "effectif_total",
         valeur > 0) %>%
  group_by(annee, esp_code_alternatif) %>% 
  summarise(n_occur = n_distinct(ope_id))

n_ope_par_an <- ope_indicateur %>% 
  filter(stade == "ind",
         indicateur == "effectif_total") %>%
  group_by(annee) %>% 
  summarise(n_ope = n_distinct(ope_id))

taux_occ <- occur %>% 
  left_join(n_ope_par_an) %>% 
  mutate(valeur = n_occur / n_ope,
         indicateur = "taux_occurrence",
         stade = "ind")
```


# Indicateurs à l'Echelle régionale

```{r Construction tab reg_indicateur, fig.height = 55, fig.width = 10}
# Calcul des données par année et pop_id en calculant la médiane de la valeur de l'indicateur ----
reg_indicateur <- ope_indicateur %>%
  group_by(esp_code_alternatif, annee, indicateur, stade) %>%
  summarize(valeur = case_when(
    indicateur == "pourcentage_juveniles" ~ mean(valeur),
    TRUE ~ median(valeur)
  )) %>%
  ungroup() %>%
  distinct()
```


```{r Construction tab reg_indicateur part 2}
taux_occ <- taux_occ %>% 
  select(names(reg_indicateur))

reg_indicateur <- reg_indicateur %>% 
  rbind(taux_occ) %>% 
  filter(!indicateur %in% c("pourcentage_site_presence_esp",
                          "longueur_mediane",
                          "densite_volumique"))

```


```{r Representation graphique des données}
reg_indicateur <- reg_indicateur %>% 
  filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR"))
```


```{r Representation graphique des données 2, fig.height = 26, fig.width = 10}
# Représentation graphique des données : 
reg_indicateur_graph <- reg_indicateur %>%
  ggplot(aes(x= annee, y =valeur, group = stade, color = stade)) + 
  geom_point(shape = 1) +
  facet_grid2(esp_code_alternatif ~ indicateur, scales = "free", independent = "y") + 
  scale_color_manual(values = c("juv" = "#92D080", "ad" = "#A97B30", "ind" = "black"),
                     name = "Stade", labels = c("Adulte", "Indifférencié", "Juvénile")) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs") +
  theme_bw()+
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill="#faf0e0"),
        panel.grid.major = element_line(color="lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.x = element_text(angle = 45)) +
  geom_smooth(data = reg_indicateur %>% 
                filter (annee %in% 2010:2023), 
              aes(x= annee, y =valeur, group = stade, color = stade),
              method = "lm",
              se = FALSE) +
  geom_smooth(data = reg_indicateur %>% 
                filter (annee %in% 2000:2013), 
              aes(x= annee, y =valeur, group = stade, color = stade),
              method = "lm", 
              se = FALSE,
              linetype = "dashed")


print(reg_indicateur_graph)

```


## Tendances globales 

Il s'agit d'observer les différentes tendances présentes sur les indicateurs précedement établis. 

```{r Fonction mk_st_by_group, fig.height = 25, fig.width = 10}
tendance_indicateur <- mk_st_by_group(ope_indicateur,
                                      var_x = annee,
                                      var_y = valeur,
                                      esp_code_alternatif,
                                      indicateur,
                                      stade, 
                                      pop_id)
```



```{r Représentation graphique tendance_indicateur ad, fig.height = 25, fig.width = 10}
tendance_indicateur %>% 
  filter(indicateur!="taux_occurrence",
         stade == "ad") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur, 
              scales = "free") +
  labs(title = "Tendances indicateurs - Adulte", 
       x = "Tendance", 
       y = "Valeurs pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        legend.position = "bottom") 
```



```{r Représentation graphique tendance_indicateur juv, fig.height = 25, fig.width = 10}
tendance_indicateur %>% 
  filter(indicateur!="taux_occurrence",
         stade == "juv") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur  , 
              scales = "free") +
  labs(title = "Tendances indicateurs - Juvénile", 
       x = "Tendance", 
       y = "Valeur pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        legend.position = "bottom") 

```


```{r Représentation graphique tendance_indicateur ind, fig.height = 25, fig.width = 10}
tendance_indicateur %>% 
  filter(indicateur!="taux_occurrence",
         indicateur!="pourcentage_site_presence_esp",
         stade == "ind") %>% 
  group_by(indicateur,
           trend,
           stade,
           esp_code_alternatif) %>% 
  summarise (n = n_distinct (pop_id)) %>% 
  ggplot(mapping = aes(x = trend,
                       y = n,
                       fill = trend)) +
  geom_bar(stat="identity") +
  facet_grid(~esp_code_alternatif ~ stade ~ indicateur  , 
              scales = "free") +
  labs(title = "Tendances indicateurs - Indifférencié", 
       x = "Tendance", 
       y = "Valeur pop_id") +
  scale_fill_manual(values = c("Decrease" = "red","Increase" = "#92D080", "No trend" ="lightgrey"),
                     name = "Tendance : ") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color="#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill="#faf0e0"),
        axis.text.x = element_text(angle = 45),
        legend.position = "bottom") 
```


## Taux d'Evolution

On souhaite calculer le taux d'évolution inter-annuel, c'est à dire entre l'année n et l'année n-1, par espèce. Si le taux d'évolution est positif, cela correspond à une croissance de la population ; si il est négatif, cela correspond à un déclin. 

```{r Calcul des taux evolution}
# Calcul des taux d'évolution depuis 1990

taux_evol_1990 <- calcul_taux_evol(df = reg_indicateur,
                             var_x = annee,
                             var_y = valeur,
                             debut = 1990,
                             esp_code_alternatif,
                             stade,
                             indicateur)
print(taux_evol_1990)

```



```{r Définition des seuils et couleurs taux evol, fig.height = 25, fig.width = 10}
# Définition des seuils et des couleurs correspondantes
seuils <- c(0.55, 0.99, 1.01, 1.25)
couleurs <- c("#CB2027", "#DDDDDD","#8fd175")
n <- length(seuils)
```


```{r Représentation graphique taux evol, fig.height = 25, fig.width = 10}
# Représentation graphique :
taux_evol_graph <- taux_evol_1990 %>%
  ggplot(aes(x = reorder(stade, mean_geom), y = mean_geom, color = stade)) +
  geom_point(shape = 19) +
  geom_line(aes(group = stade)) +
  facet_grid(~ esp_code_alternatif ~ indicateur, scales = "free") +
  labs(title = "Taux évolution", x = "Stade", y = "Moyenne Géométrique") +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        panel.grid.major = element_line(color = "#ffffff", size = 0.1),
        panel.grid.minor = element_line(color = "#ffffff"),
        panel.background = element_rect(fill = "#faf0e0"),
        legend.position = "bottom") + 
  scale_color_manual(values = c("juv" = "#92D080", "ad" = "#A97B30", "ind" = "black"),
                     name = "Stade", labels = c("Adulte", "Indifférencié", "Juvénile"))


 for (i in 1:(n-1)) {
   taux_evol_graph <- taux_evol_graph +
     annotate("rect", xmin = -Inf, xmax = Inf, ymin = seuils[i], ymax = seuils[i+1], fill = couleurs[i], alpha = 0.1)
 }

print(taux_evol_graph)

```

### Vérification des taux d'évolutions obtenus 

On souhaite ici avoir une vérification de la cohérence des données obtenues sur les taux d'évolution, on souhaite alors regarder les taux d'évolution sur un paramètres particulier : les effectifs. 

```{r Pré traitement des données testées pour vérif taux évolution 1990}
# Sélection de l'indicateur souhaité pour la vérification
indicateur_sel <- "effectif_total"

# On regarde les taux d'évolution seulement pour le stade "indiférencié"
taux_evol_eff <- taux_evol_1990 %>% 
  filter (indicateur == indicateur_sel,
          stade == "ind")
```


```{r Pré traitemenent part 2}
tendance_indicateur_eff <- tendance_indicateur %>% 
  filter (indicateur == indicateur_sel,
          stade == "ind") %>% 
  select(-pop_id) %>% 
  group_by(esp_code_alternatif) %>% 
  mutate(med_Sen = median(sens_slope))
```


```{r Construction final du tableau tendance_indicateur_eff pour la vérif}
tendance_indicateur_eff <- tendance_indicateur_eff %>% 
  left_join(taux_evol_eff) %>% 
  select (esp_code_alternatif,
          mean_geom,
          med_Sen) %>% 
  unique()
```


Observation de ce qu'il se passe au niveau des taux d'évolution : On s'attend, sur le graphique produit, à avoir les données d'espèces d'aligner sur une droite : 

```{r}
tendance_indicateur_gra <- tendance_indicateur_eff %>% 
  filter(!esp_code_alternatif %in% c("FLE", "MUP", "PLI", "LPR", "ALF" )) %>%  # On retire les espèces qui ont trop peu de données pour être évaluées
  ggplot(aes(x = mean_geom, y = med_Sen,  label = esp_code_alternatif)) +
  geom_smooth(method = "lm", se = TRUE) + 
  geom_point() + 
  geom_hline(yintercept = 0,
             linetype = "dotted") +
  geom_vline(xintercept = 1,
             linetype = "dotted") +
  ggrepel::geom_text_repel()
 
print(tendance_indicateur_gra)
```








Je souhaite visualiser l'évolution de la densité d'une espèce sur un point de prélèvement dans le temps : 

```{r}
# Filtrer les données pour une espèce donnée et une station donnée
esp_specifique <- "ANG"  # Remplacer par le code de l'espèce spécifique
pop_specifique <- "46221"  # Remplacer par l'ID de la station spécifique

donnees_filtrees <- subset(ope_indicateur, esp_code_alternatif == esp_specifique & pop_id == pop_specifique)

donnees_filtrees <- donnees_filtrees %>% 
  filter(indicateur == "densite_surface",
         stade == "ind")

# Créer le graphique
ggplot(donnees_filtrees, aes(x = as.factor(annee), y = valeur)) +
  geom_line() +
  geom_point() +
  labs(x = "Année", y = "Densité", title = paste("Évolution de la densité de l'espèce", esp_specifique, "sur la station", pop_specifique)) +
  theme_minimal()


```



# Sauvegarde : 

```{r Sauvegarde}
# SAUVEGARDE ----
save(taux_occ,
     reg_indicateur,
     taux_evol_1990,
     file = "../processed_data/calcul_indicateurs_regionaux.rda")
```







--------------------------------------------------------------------------------

Optionnel (expérimentale) :

# Modèles Linéaires Généralisés (GLM) :

Utilisation des modèles GLM afin de modéliser la distribution des espèces - ces modèles sont utiles pour modéliser la dynamique des populations en fonction de facteurs environementaux.


Transformer les valeurs de densités (surface et volume) en log pour les analyses (car les valeurs sont parfois très élevées) : 

```{r Transformation données densités en log}
data <- ope_selection %>% 
  select(ope_id,
         pro_libelle) 

glm_ope_indicateur <- ope_indicateur %>% 
  mutate (valeur_l = ifelse (grepl("densite", indicateur),
                               log(1 + valeur),
                               valeur)) %>%  
  left_join(data)
```



Exclure du jeu de données les lignes avec moins de 5 années de données (données trop peu robuste pour réaliser une analyse) : 

```{r Paramétrage années minimum GLM}
nb_annee_glm <- 5
```


```{r Construction tableau glm_ope_indicateur}
glm_ope_indicateur <- glm_ope_indicateur %>%
  group_by(esp_code_alternatif, indicateur, stade) %>%
  filter(n_distinct(annee) >= nb_annee_glm) %>%
  ungroup() %>% 
  select(-valeur)
```


## Réalisation GLM (Individuel)

```{r Réalisation GLM Individuel}
mon_espece <- "ANG"
mon_stade <- "ind"
mon_indicateur <- "densite_volumique"

glm_data_ang <- glm_ope_indicateur %>% 
  ungroup() %>% 
  filter(indicateur == mon_indicateur,
         esp_code_alternatif == mon_espece,
         stade == mon_stade)

glm_ang <- calcul_glm_non_groupe(glm_data_ang)
glm_ang <- glm_ang %>% 
  mutate(esp_code_alternatif = "ANG",
         stade = "ind",
         indicateur = "densite_volumique")

```


## Réalisation GLM (Collectif)

```{r Realisation GLM collectif}
combinaisons_glm_coll <- unique(select(glm_ope_indicateur, esp_code_alternatif, stade, indicateur))

glm_collectif <- combinaisons_glm_coll %>%  # Appliquer la fonction calcul_glm_non_groupe à chaque combinaison
  pmap_dfr(~calcul_glm_non_groupe(glm_ope_indicateur %>%
                                    filter(esp_code_alternatif == ..1 & stade == ..2 & indicateur == ..3)) %>%
             mutate(esp_code_alternatif = ..1, 
                     stade = ..2, 
                     indicateur = ..3)) %>% 
  rename (glm_intercept = intercept,
          glm_pvalue = pvalue,
          glm_annee = annee) %>% 
  select (esp_code_alternatif,
          stade,
          indicateur,
          glm_intercept, 
          glm_annee,
          glm_pvalue)

```


Représentation visuelle des résultats GLM collectif

```{r Attribution significativité Tab GLM, fig.height = 5, fig.width = 10}
glm_collectif <- glm_collectif %>%
  mutate(significativité = case_when(
    glm_pvalue <= 0.001 ~ '***',
    glm_pvalue <= 0.01 ~ '**',
    glm_pvalue <= 0.05 ~ '*',
    glm_pvalue <= 0.1 ~ '.',
    TRUE ~ ' '
  ))
```


```{r Représentation Tab GLM, fig.height = 5, fig.width = 10}
glm_collectif %>%
  gt() %>%
  tab_header(
    title = "Résultats des modèles GLM",
    subtitle = "Tableau synthétique des coefficients, années et p-values"
  ) %>%
  fmt_number(
    columns = vars(glm_intercept, glm_annee, glm_pvalue),
    decimals = 3
  )
```
