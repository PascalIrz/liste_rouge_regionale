---
title: "20_modeles_occupation"
author: "Léa Bouchet"
date: "2024-04-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Modèles d'occupation

On souhaite ici appliquer le package "spOccupancy": On souhaite structurer notre jeu de données de la même manière afin de pouvoir réaliser les mêmes analyses avec nos données ASPE Bretagne.La première étape est de transformer le jeu de données en détection / non détection (présence / absence d'un espèce : TRUE / FALSE) sur un site donné. Le premier modèle tester est un modèle d'occupation d'une seule espèce (donc à l'espèce).


## Installation 

### Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library (khroma)
library(dplyr)
library(wesanderson)
library(zoo)
library(lemon)
library(trend)
library(ggh4x)
library(spOccupancy)
library(coda)
library(stars)
```


```{r Chargement des sauvegardes}
## Chargement des sauvegardes ----
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
```


```{r Chargement des palettes de couleurs}
# Définition des couleurs de l'OFB en format RGB
pal <- c("#007844", "#92D050", "#0087C1", "#FCEE21", "#00AEEF", "#1D1D1B", "#A97B30", "#B9D9EB")
```


# Constitution du jeu de données

On souhaite transformer notre jeu de données en ABSENCE / PRESENCE : où absence = 0 et présence = 1 : 
Réalisation pour le Brochet (BRO) dans un premier temps: "Extract Detection-nondetection Data"

```{r Paramétrage ABS PRE espèce}
mon_espece <- "BRO"
```


```{r Pré-traitements création df ABS PRE pour BRO}
ope_ind <- ope_indicateur %>% 
  filter(indicateur == "densite_surface") %>% 
  select (ope_id,
          esp_code_alternatif
           ) %>% 
  unique() %>% 
  mutate (presence = 1)


mes_combinaisons <- expand.grid(ope_ind$ope_id, ope_ind$esp_code_alternatif) %>% 
  distinct() %>% 
  rename(ope_id = Var1,
         esp_code_alternatif = Var2)
```


```{r Création df ABS PRE pour BRO}
y <- mes_combinaisons %>% 
  left_join(y = ope_ind) %>% 
  mutate(presence = ifelse(is.na(presence), 0, presence)) %>% 
  left_join(y = ope_selection %>% 
              select(ope_id,
                     pop_id,
                     annee
                    # ope_date
                     )) %>% 
              select(-ope_id) %>% 
              distinct() %>% 
#  mutate(annee = paste0("a_", annee)) %>% 
  filter(esp_code_alternatif == mon_espece) %>% 
  select(-esp_code_alternatif) %>% 
  arrange(annee) %>% 
  pivot_wider(names_from = annee,
              values_from = presence) %>% 
  arrange(pop_id)
```


## Covariables d'occurrence : 

Les covariables d’occurrence sont stockées sous forme de matrice ou de base de données, avec des lignes correspondant aux sites et des colonnes correspondant aux différentes covariables que nous souhaitons inclure dans le modèle. Ici, nous avons une seule covariable (elev) et nous la convertissons en une base de données dans le bloc de code suivant.

```{r Détermination co-variables occurrence part 1}
occ.covs <- ope_selection_param_env %>% 
  group_by(pop_id, parametre) %>% 
  summarise(valeur = median(valeur, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(valeur = log10(valeur)) %>% 
  pivot_wider(names_from = parametre,
              values_from = valeur) %>% 
  arrange(pop_id)
```


```{r Détermination co-variables occurrence part 2}
test <- ope_selection %>% 
  mutate(jour = lubridate::yday(ope_date)) %>% 
  mutate(protocole = as.factor(pro_libelle),
         protocole = as.integer(protocole)) %>% 
  select(pop_id,
         annee,
         jour,
         protocole)

jour <- test %>% 
  select(-protocole) %>% 
  arrange(annee) %>% 
  pivot_wider(names_from = annee,
              values_from = jour) %>% 
  arrange(pop_id)

protocole <- test %>% 
  select(-jour) %>% 
  arrange(annee) %>% 
  pivot_wider(names_from = annee,
              values_from = protocole) %>% 
  arrange(pop_id)

modele_bro <- list()
```


```{r Application des co-variables}
modele_bro$y <- y
modele_bro$occ.covs <- occ.covs
modele_bro$det.covs$jour <- jour
modele_bro$det.covs$protocole <- protocole
```


```{r Etablissement des formules}
bro.occ.formula <- ~ scale(profondeur) + scale(pente) + scale(temp_juillet)
bro.det.formula <- ~ scale(jour) + scale(protocole) + I(scale(jour)^2)
```

```{r}
bro.inits <- list(alpha = 0, 
                   beta = 0, 
                   z = apply(modele_bro$y, 1, max, na.rm = TRUE))
```

```{r}
bro.priors <- list(alpha.normal = list(mean = 0, var = 2.72), 
                    beta.normal = list(mean = 0, var = 2.72))
```

```{r}
n.samples <- 5000
n.burn <- 3000
n.thin <- 2
n.chains <- 3
```

```{r}
out <- PGOcc(occ.formula = bro.occ.formula, 
             det.formula = bro.det.formula, 
             data = modele_bro, 
             inits = bro.inits, 
             n.samples = n.samples, 
             priors = bro.priors, 
             n.omp.threads = 1, 
             verbose = TRUE, 
             n.report = 1000, 
             n.burn = n.burn, 
             n.thin = n.thin, 
             n.chains = n.chains)
```


Représentation visuelle des résultats : 
Pour 'beta' : 

```{r Représentation plot beta}
plot(out, 'beta', density = FALSE) # Occupancy parameters.
```


Pour 'alpha' : 

```{r Représentation plot alpha}
plot(out, 'alpha', density = FALSE) # Detection parameters.
```


# Sauvegarde

```{r Sauvegarde}
save(ope_indicateur,
     modele_bro,
     file = "../processed_data/modeles_occupation.rda")
```

