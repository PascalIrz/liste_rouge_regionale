---
title: "96_analyses_stations"
author: "Léa Bouchet"
date: "2024-06-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


Ce script à pour objectif de réaliser des pré-traitement avant l'appliquation de la méthodologie de la liste rouge régionale - UICN 2012 sur les données. Ce script contient 1 grande étape : la sélection des espèces à évaluer. 


# Chargement des packages

```{r Chargement des packages}
library(aspe)
library(tidyverse)
library(ggplot2)
library(readxl)
library(dplyr)
library(ggh4x)
library(kableExtra)
library(ggthemes)
library (khroma)
library(dplyr)
library(zoo)
library(gt)
library(lemon)
library(trend)
library(ggh4x)
library(purrr)
```


# Chargement des données

```{r chargement des données}
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
```

# Chargement excel "selection_taxon_lrr"

```{r Chargement Excel}
## Fichier Excel contenant les différentes espèces de la région ainsi que leurs temps de générations, leurs statuts d'endémisme à la région
reg_espece <- read_excel("../raw_data/selection_taxon_lrr.xlsx")
```


# Chargement d'une palette de couleur

```{r}
# Définir une palette de couleurs personnalisée
my_palette <- c("grey", heat.colors(99))
```



# Principales étapes d'un projet de Liste Rouge Régionale 

La mise en oeuvre d'un projet d'élaboration d'une Liste Rouge Régionale peut se décomposer en 3 étapes, présentées et réalisées ci-dessous (application à l'échelle de la Bretagne): 



## Identification des espèces soumises au processus d'évaluation : 

   1) Etablir la liste des espèces présentes dans la région, sur la base d'un référentiel taxonomique et d'un catalogue régional de référence. Les espèces présentes dans la région sont répertoriées au sein d'un excel et mis dans un dataframe (reg_espece).


   2) Identifier dans cette liste les espèces ne devant pas être soumis à l'évaluation, à placer en catégorie "Non Applicable" (NA). A une échelle régionale, certaines espèces ne doivent pas être soumises au processus d'évaluation. Il s'agit des espèces introduites et des espèces erratiques pour lesquelles la méthodologie n'est pas applicable. 


Espèces introduites et indigènes : Il est nécessaire de définir des principes généraux permettant de déterminer la limte entre espèces introduites et espèces indigènes. De manière générale, il est recommandé de considérer les espèces introduites après 1500 comme non indigènes. Toutefois, pour certains groupes taxonomiques, les experts peuvent s'accorder sur d'autres principes analogues si la situation le justifie. 

Espèces erratiques : une espèce est considérée comme erratique lorsque sa présence dans la région est occasionnelle, c'est à dire en général irrégulière et peu fréquente. Pour distinguer les espèces régulièrement présentes des espèces erratiques, il convient de s'accorder sur des principes reposant en particulier sur la fréquence d'observation de l'espèce dans la région. 



Pour l'exemple de la Bretagne, ces dernières sont renseignées sous forme de "NA" dans la colonne "statut_lrr". Les statuts renseignés correspondent à ceux utilisé dans la précédente liste rouge régionale :

```{r Création statut_lrr}
# Ajout colonne "statut_lrr" pour indiquer les espèces soumises et non soumises au processus d'évaluation
reg_espece$statut_lrr <- ifelse(reg_espece$statut_esp %in% c("introduite", "erratique"),
                                "NA", 
                                "Applicable")
```


# Prétraitement des dataframes 


## Les Absences et les Présences des espèces 

Les absences de valeurs d'effectifs (valeurs effectif = 0) doivent être intégrés dans les différents dataframes traités lorsque l'espèce a été présente au moins une fois sur une des stations : 

### Dataframe reg_indicateur

```{r Ajout des Présences / Absences reg_indicateur}
# Création d'un dataframe avec toutes les combinaisons possibles d'années, indicateurs, stades et esp_code_alternatif
combinaisons_esp_sta <- expand.grid(annee = unique(reg_indicateur$annee),
                            indicateur = unique(reg_indicateur$indicateur),
                            stade = unique(reg_indicateur$stade),
                            esp_code_alternatif = unique(reg_indicateur$esp_code_alternatif))
```


```{r Ajout des Présences / Absences reg_indicateur}
# Fusionner le tableau des combinaisons avec le tableau original en ajoutant des valeurs manquantes avec valeur 0
reg_indicateur_complet <- combinaisons_esp_sta %>%
  left_join(reg_indicateur, by = c("annee", "indicateur", "stade", "esp_code_alternatif")) %>%
  mutate(valeur = ifelse(is.na(valeur), 0, valeur))

```


### Dataframe ope_selection  

```{r Ajout des Présences / Absences ope_indicateur}
# Création d'un dataframe avec toutes les combinaisons possibles d'années, indicateurs, stades et esp_code_alternatif
combinaisons_esp_ope <- expand.grid(annee = unique(ope_indicateur$annee),
                            indicateur = unique(ope_indicateur$indicateur),
                            stade = unique(ope_indicateur$stade),
                            esp_code_alternatif = unique(ope_indicateur$esp_code_alternatif),
                            pop_id = unique(ope_indicateur$pop_id))
```


```{r Ajout des Présences / Absences ope_indicateur}
# Fusionner le tableau des combinaisons avec le tableau original en ajoutant des valeurs manquantes avec valeur 0
ope_indicateur_complet <- combinaisons_esp_ope %>%
  left_join(ope_indicateur, by = c("annee", "indicateur", "stade", "esp_code_alternatif", "pop_id"))%>%
  mutate(valeur = ifelse(is.na(valeur), 0, valeur))

```


## Point de vue global sur les données disponibles (effectifs) : 

```{r}
# Filtrer les données pour l'indicateur 'effectif_total'
ope_indicateur_effectif <- ope_indicateur_complet %>%
  filter(indicateur == 'effectif_total', 
         stade == "ad") %>%
  group_by(esp_code_alternatif, annee) %>%
  summarize(effectif_total_cumule = sum(valeur)) %>%
  pivot_wider(names_from = annee, values_from = effectif_total_cumule, values_fill = 0)

```


## Taux d'occurrence des espèces par station

Nous souhaitons ici avoir un point de vue globale sur nos stations et 

```{r}
nombre_total_stations <- n_distinct(ope_indicateur_complet$pop_id)
nombre_valeurs_esp <- length(unique(ope_indicateur_complet$esp_code_alternatif))

nombre_total_annee <- ope_indicateur_complet %>%
  group_by(esp_code_alternatif) %>%
  summarise(nombre_annees = max(annee) - min(annee)) %>% 
  pull()

```

J'ai ici 43 stations, maintenant je cherche à savoir pour chaque espèces, combien d'occurence de présence au sein des stations elles sont présentes (et lesquelles).

```{r}
tab_analyse_bay <- ope_indicateur_complet %>% 
  filter(stade == "ad",
         indicateur == "effectif_total") %>%
  group_by(pop_id, annee, esp_code_alternatif)
```


```{r}
tab_analyse_bay <- tab_analyse_bay %>%
  group_by(esp_code_alternatif, pop_id) %>%
  summarize(somme_obs_esp_sta = sum(valeur > 0)) %>% 
  ungroup()
```

```{r}
# Filtrer les espèces présentes sur plus de 20% au sein de chacune des stations
tab_analyse_bay <- tab_analyse_bay %>%
  group_by(esp_code_alternatif) %>%
  filter(somme_obs_esp_sta >= 0.20 * nombre_total_annee) %>% 
  mutate(nombre_total_stations_20 = n_distinct(pop_id)) %>% 
  filter(nombre_total_stations_20 > 10)
```


```{r Sauvegarde}
# SAUVEGARDE ----
save(tab_analyse_bay,
     ope_indicateur_complet,
     file = "../processed_data/pre_traitement_criteres_lrr_uicn.rda")
```


