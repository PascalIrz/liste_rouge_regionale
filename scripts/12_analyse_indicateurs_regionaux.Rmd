---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Analyse des indicateurs régionaux"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```


# Objectif : Dynamique de population des poissons d'eau douce de Bretagne

Script : 12_analyse_indicateurs_regionaux



A l'issue de ce script, une approche analytique aura été réalisée et une comparaison de résultats sera ainsi possible avec des modèles d'analyses plus poussés (cf - Script 20_modele_bayesien). 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages
library(tidyverse)
library(aspe)
library(gt)
library(ggh4x)
library(broom)
```


```{r Chargement des données}
## Chargement des données
load(file = "../processed_data/selection_pop_ope.rda")
load(file = "../processed_data/pre_traitements_donnees_env.rda")
load(file = "../processed_data/assemblage_tab_par_ope.rda")
load(file = "../processed_data/analyse_selection_especes.rda")
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
```


```{r Chargement des fonctions}
## Chargement des fonctions 
source(file = "../R/mk_st_by_group.R")
source(file = "../R/calcul_taux_evolution.R")
source(file = "../R/mann_kendall_sen.R")
```


```{r Chargement de la palette de couleur}
# Définition des couleurs de l'OFB en format RGB
pal <- c("#007844", "#92D050", "#0087C1", "#FCEE21", "#00AEEF", "#1D1D1B", "#A97B30", "#B9D9EB")
```




# Significativité des indicateurs

Il est maintenant nécessaire d'observer si les valeurs obtenues relatives à l'ensemble de ces indicateurs regionaux sont significatifs sur l'ensemble des sous-périodes et périodes qui nous intéresse (en résonnance avec l'étude de révision de la liste rouge régionale). 


La fonction "get_pvalues" a pour but de calculer et d'extraire les p-values des coefficients de régression linéaire des valeurs par rapport aux annees, pour chaque combinaison unique de stade, indicateur, et esp_code_alternatif, sur la période spécifiée par start_year et end_year. Les p-values obtenues pourront ensuite être utilisées pour connaître la significativité statistique des tendances temporelles des indicateurs pour les différentes espèces et stades.

Dans le contexte de la réactualisation de la liste rouge régionale de Bretagne, 5 périodes  nous interesse : il s'agit des 5 fenêtres temporelles étudiées correspondant aux périodes d'études (en relation avec les temps de génération) des espèces étudiées. 

Mais avant nous nous interessons à 3 autres fenêtres temporelles : 
- 1) La période d'étude de l'ancienne liste rouge régionale (2000-2013)
- 2) La nouvelle période d'étude de la liste rouge régionale 2023 (2010-2023)
- 3) La période globale - la plus longue dont nous disposion (1990-2023)

Création d'une fonction qui nou spermet de récupérer les valeurs issues des regression linéaires sur les indicateurs de tendances régionales pour chaque période d'études : 


```{r Fonction get_pvalues}
get_pvalues <- function(data, 
                        start_year, 
                        end_year) {
  
  data_filtered <- data %>% 
    filter(annee >= start_year & annee <= end_year)
  
  results <- data_filtered %>%
    group_by(stade, 
             indicateur, 
             esp_code_alternatif) %>%
    do(tidy(lm(valeur ~ annee, data = .)))
  
  results %>% 
    filter(term == "annee") %>% 
    select(indicateur, 
           esp_code_alternatif, 
           estimate, 
           p.value)
}
```

Application de la fonction sur nos périodes d'études : 

```{r Fonction get_pvalues application}
reg_indicateur_pvalues_2010_2023 <- get_pvalues(reg_indicateur,2010,2023) # Test pour la période 2010-2023
reg_indicateur_pvalues_2000_2013 <- get_pvalues(reg_indicateur,2000,2013) # Test pour la période 2000-2013
reg_indicateur_pvalues_1990_2023 <- get_pvalues(reg_indicateur,1990,2023) # Test pour la période 1990-2023
```


Un seuil de significativité est ajouté aux données calculés par get_pvalues (seuil de significativité = 0.05). 

```{r Ajout significativité }
# Ajouter la colonne de signification
reg_indicateur_pvalues_2010_2023 <- reg_indicateur_pvalues_2010_2023 %>%
  mutate(significance = ifelse(p.value < 0.05, "significant", "non_significant")) 

colnames(reg_indicateur_pvalues_2010_2023)[colnames(reg_indicateur_pvalues_2010_2023) == "significance"] <- "significance_2010_2023"
colnames(reg_indicateur_pvalues_2010_2023)[colnames(reg_indicateur_pvalues_2010_2023) == "estimate"] <- "estimate_2010_2023"
colnames(reg_indicateur_pvalues_2010_2023)[colnames(reg_indicateur_pvalues_2010_2023) == "p.value"] <- "p.values_2010_2023"


reg_indicateur_pvalues_1990_2023 <- reg_indicateur_pvalues_1990_2023 %>%
  mutate(significance = ifelse(p.value < 0.05, "significant", "non_significant")) 

colnames(reg_indicateur_pvalues_1990_2023)[colnames(reg_indicateur_pvalues_1990_2023) == "significance"] <- "significance_1990_2023"
colnames(reg_indicateur_pvalues_1990_2023)[colnames(reg_indicateur_pvalues_1990_2023) == "estimate"] <- "estimate_1990_2023"
colnames(reg_indicateur_pvalues_1990_2023)[colnames(reg_indicateur_pvalues_1990_2023) == "p.value"] <- "p.values_1990_2023"



reg_indicateur_pvalues_2000_2013 <- reg_indicateur_pvalues_2000_2013 %>%
  mutate(significance = ifelse(p.value < 0.05, "significant", "non_significant"))

colnames(reg_indicateur_pvalues_2000_2013)[colnames(reg_indicateur_pvalues_2000_2013) == "significance"] <- "significance_2000_2013"
colnames(reg_indicateur_pvalues_2000_2013)[colnames(reg_indicateur_pvalues_2000_2013) == "estimate"] <- "estimate_2000_2013"
colnames(reg_indicateur_pvalues_2000_2013)[colnames(reg_indicateur_pvalues_2000_2013) == "p.value"] <- "p.values_2000_2013"
```



On agrège ces données au tableau bilan *reg_indicateur_tendances_lm* :

```{r Ajout significativité reg_indicateur}
# Joindre les p-values au tableau d'origine (reg_indicateur)
reg_indicateur_tendances_lm <- reg_indicateur %>%
  left_join(reg_indicateur_pvalues_1990_2023 %>%
              select(p.values_1990_2023, 
                     estimate_1990_2023,
                     significance_1990_2023), 
            by = c("stade", "indicateur", "esp_code_alternatif")) %>%
  mutate(trend_1990_2023 = case_when(estimate_1990_2023 > 0 ~ "\U2197",
                            estimate_1990_2023 < 0 ~ "\U2198",
                            TRUE ~ "."),
         sig_1990_2023 = case_when(
           p.values_1990_2023 < 0.001 ~ "***",
           p.values_1990_2023 < 0.01 ~ "**",
           p.values_1990_2023 < 0.05 ~ "*",
           TRUE ~ "")) %>%
  left_join(reg_indicateur_pvalues_2010_2023 %>%
              select(p.values_2010_2023, 
                     estimate_2010_2023,
                     significance_2010_2023), 
            by = c("stade", "indicateur", "esp_code_alternatif")) %>%
  mutate(trend_2010_2023 = case_when(estimate_2010_2023 > 0 ~ "\U2197",
                            estimate_2010_2023 < 0 ~ "\U2198",
                            TRUE ~ ".")) %>% 
  left_join(reg_indicateur_pvalues_2000_2013 %>% 
               select(p.values_2000_2013, 
                     estimate_2000_2013,
                     significance_2000_2013),
            by = c("stade", "indicateur", "esp_code_alternatif")) %>%
  mutate(trend_2000_2013 = case_when(estimate_2000_2013 > 0 ~ "\U2197",
                            estimate_2000_2013 < 0 ~ "\U2198",
                            TRUE ~ "."))

```


## Représentation graphique des indicateurs de tendances démographiques 

```{r, fig.height = 26, fig.width = 10}
# Créer le graphique
reg_indicateur_graph <- reg_indicateur_tendances_lm %>%
  ggplot(aes(x = annee, y = valeur, group = stade, color = stade)) +
  geom_point(shape = 1) +
  facet_grid2(esp_code_alternatif ~ indicateur, scales = "free", independent = "y") +
  scale_color_manual(values = c("juv" = "#92D080", "ad" = "#A97B30", "ind" = "black"),
                     name = "Stade", labels = c("Adulte", "Indifférencié", "Juvénile")) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.x = element_text(angle = 45))

# Ajouter les lignes de régression avec des styles différents selon la signification
reg_indicateur_graph <- reg_indicateur_graph +
  geom_smooth(data = reg_indicateur_tendances_lm %>% filter(annee %in% 2010:2023, significance_2010_2023 == "significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "solid") +
  geom_smooth(data = reg_indicateur_tendances_lm %>% filter(annee %in% 2010:2023, significance_2010_2023 == "non_significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "dashed") +
  geom_smooth(data = reg_indicateur_tendances_lm %>% filter(annee %in% 2000:2013, significance_2000_2013 == "significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "solid") +
  geom_smooth(data = reg_indicateur_tendances_lm %>% filter(annee %in% 2000:2013, significance_2000_2013 == "non_significant"),
              aes(x = annee, y = valeur, group = stade, color = stade),
              method = "lm", se = FALSE, linetype = "dashed")

print(reg_indicateur_graph)

```


Cette représentation graphique contient tous les indicateurs ainsi que l'ensemble des espèces. Il est très peu lisible et compliqué à interpreter (avec des droites qui influencent beaucoup l'interprétation des résultats). Le fait qu'il y ai plusieurs stades peut également compliquer la comprehension. 


On produit donc un graphique qu'avec les données des individus "ind" ainsi qu'avec des indicateurs restreints : 



### Tri des espèces
On ne retient qeue les espcèes pour lesquelles nous avons un fort intérêt (au vu des premières tendances dégagées et dans l'optique de la réactualisation de la LRR). 

```{r Tri espèces}
reg_indicateur_reduit <- reg_indicateur %>% 
  filter(esp_code_alternatif %in% c("ANG","BRO", "CHA", "CHE",
                                    "PER", "GAR", "GOU", "LOF", "LPP",
                                    "SAT", "TRF", "VAI", "VAR"))
```


## Tri dans les indicateurs
On ne retient que les indicateurs les plus pertinents à l'analyse des tendances.
On réalise un pré-traitement dans les données de notre reg_indicateur : sélection que des stades ind pour toutes les espèces et sélection de 3 indicateurs : 

```{r Tri indicateurs}
reg_indicateur_lrr_tendances_lm <- reg_indicateur_reduit %>% 
filter(!indicateur %in% c("pourcentage_site_presence_esp",
                          "longueur_mediane",
                          "densite_volumique",
                          "effectif_total",
                          "biomasse")) %>% 
  filter(!(indicateur == "densite_surface" & esp_code_alternatif == "VAI" & stade == "ad" & valeur > 0.08)) %>% # Enlève une valeur aberrante
  filter(stade == "ind")

```

```{r Rebnommer les étiquettes}
indicateur_labels <- c(
  "densite_surface" = "Densité surfacique",
  "pourcentage_juveniles" = "Pourcentage de juvéniles",
  "taux_occurrence" = "Taux d'occurrence"
)
```


```{r, fig.height = 8, fig.width = 10}
reg_indicateur_graph_reduit <- reg_indicateur_lrr_tendances_lm %>%
  filter(indicateur %in% c("densite_surface",
                           "pourcentage_juveniles",
                           "taux_occurrence")) %>% 
  filter(esp_code_alternatif %in% c("ANG", "TRF", "GAR")) %>% 
  ggplot(aes(x = annee, 
             y = valeur, 
             group = stade, 
             color = "Indeterminé")) +  # Fix color to a single legend item
  geom_point(shape = 1) +
  geom_smooth(method = "loess", se = FALSE) +  # Add loess trend lines
  facet_grid2(esp_code_alternatif ~ indicateur, 
              scales = "free", 
              independent = "y", 
              labeller = labeller(indicateur = indicateur_labels)) +  # Use custom labels
  scale_color_manual(values = c("Indeterminé" = "black"),
                     name = "Stade", labels = c("Indeterminé")) +
  labs(title = "Indicateurs de tendances à l'échelle régionale des espèces de poissons d'eau douce",
       x = "Années", 
       y = "Valeurs") +
  theme_bw() +
  theme(strip.background = element_rect(color = "black", fill = "#faffff"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "#faf0e0"),
        panel.grid.major = element_line(color = "lightgrey", size = 0.1),
        panel.grid.minor = element_line(color = "lightgrey"),
        axis.text.x = element_text(angle = 45))

print(reg_indicateur_graph_reduit)

```

```{r}
get_pvalues <- function(data, 
                        start_year, 
                        end_year) {
  
  data_filtered <- data %>% 
    filter(annee >= start_year & annee <= end_year)
  
  results <- data_filtered %>%
    group_by(stade, 
             indicateur, 
             esp_code_alternatif) %>%
    do(tidy(lm(valeur ~ annee, data = .)))
  
  results %>% 
    filter(term == "annee") %>% 
    select(indicateur, 
           stade,
           esp_code_alternatif, 
           estimate, 
           p.value)
}
```

```{r}
# Définir une fonction pour calculer les p-values
calculate_pvalues <- function(data, 
                              codes, 
                              start_year, 
                              end_year) {
  filtered_data <- data %>% 
    filter(esp_code_alternatif %in% codes)
  
  pvalues <- get_pvalues(filtered_data, 
                         start_year, 
                         end_year)
  
  pvalues <- pvalues %>%
    mutate(significativite = ifelse(p.value < 0.05, "significatif", "non_significatif"),
           periode = paste0(start_year, "_", end_year))
  
  return(pvalues)
}
```


```{r}
# Définir une fonction pour joindre les p-values au dataframe d'origine
join_pvalues <- function(original_data, pvalues_data) {
  join_cols <- c("esp_code_alternatif", 
                 "indicateur")
  
  pvalues_data <- original_data %>%
    select(all_of(join_cols)) %>%
    distinct() %>%
    right_join(pvalues_data, by = c("esp_code_alternatif", "indicateur"))
  
  result <- original_data %>%
    left_join(pvalues_data, by = join_cols) %>%
    mutate(trend = case_when(
      estimate > 0 ~ "\U2197",
      estimate < 0 ~ "\U2198",
      TRUE ~ "."),
      sig = case_when(
        p.value < 0.001 ~ "***",
        p.value < 0.01 ~ "**",
        p.value < 0.05 ~ "*",
        TRUE ~ ""))
  
  return(result)
}

# Liste des groupes et des périodes
groups <- list(
  list(codes = "ANG", start_year = 1990, end_year = 2023),
  list(codes = c("CHE", "LPP"), start_year = 2005, end_year = 2023),
  list(codes = c("BRO", "LOF"), start_year = 2008, end_year = 2023),
  list(codes = c("VAR", "GAR", "VAI", "PER"), start_year = 2011, end_year = 2023),
  list(codes = c("SAT", "GOU", "TRF", "CHA"), start_year = 2013, end_year = 2023)
)
```


```{r}
# Calculer les p-values pour chaque groupe et les joindre au dataframe original
reg_indicateur_lrr_tendances_lm <- reg_indicateur_lrr_tendances_lm
all_pvalues <- data.frame()

for (group in groups) {
  pvalues <- calculate_pvalues(reg_indicateur_lrr_tendances_lm, 
                               group$codes, 
                               group$start_year, 
                               group$end_year)
  
  all_pvalues <- bind_rows(all_pvalues, 
                           pvalues)
}

reg_indicateur_lrr_tendances_lm <- join_pvalues(reg_indicateur_lrr_tendances_lm, 
                                                      all_pvalues)

# Sélectionner les colonnes nécessaires et renommer pour le format final
reg_indicateur_lrr_tendances_lm <- reg_indicateur_lrr_tendances_lm %>%
  select(esp_code_alternatif, stade.x , indicateur, estimate, p.value, significativite, trend, sig, periode) %>%
  unique() %>% 
  rename(p_value = p.value, significativite_valeur = significativite)

# Afficher le nouveau dataframe
print(reg_indicateur_lrr_tendances_lm)
```


## Synthèse des premiers résultats

Toujours par soucis de lisibilité, seul les 3 indicateurs retenus apparaîtrons dans ce tableau final. Dans notre étude, les valeurs de densité de surface, le pourcentage de juvéniles et le taux d'occurrence semblent être les 3 données les plus parlantes et représentatives de l'état des populations de poissons d'eau douce de Bretagne. Ces informations sont alors synthétisées dans un tableau, sur deux périodes différentes. Les flèches vers le haut indiquent une croissance et celle vers le bas une décroissance de l'indicateur pour l'espèce concernée. 




```{r}
# Créer le tableau synthétique avec gt
tab_reg_indicateur_lrr_tendances_lm <- reg_indicateur_lrr_tendances_lm %>%
  select(esp_code_alternatif,
         periode,
         indicateur,
         trend,
         sig) %>% 
  arrange(esp_code_alternatif, 
          indicateur) %>%   # Ordonner par espèce, indicateur et stade
  gt() %>%
  tab_header(
    title = "Synthèse des tendances des indicateurs des populations de poissons d'eau douce de Bretagne"
  ) %>%
  cols_label(
    esp_code_alternatif = "Code Espèce",
    indicateur = "Indicateur",
    trend = "Tendance Regression linéaire",
    sig = "Significativité") %>%
  tab_options(table.font.size = "small", data_row.padding = px(5))

# Afficher le tableau
tab_reg_indicateur_lrr_tendances_lm

```



On suspect un effet des réseaux et des protocoles dans ces résultats (en effet des changements de protocoles et de réseaux ont lieux au cours du temps). Le prochain script (13_glm) à pour but d'évaluer, grâce à des modèles linéaires mixtes, les éventuels effets de ces changements de réseaux et de protocoles. 



# Sauvegarde 

```{r Sauvegarde}

save(reg_taux_occ,
     reg_indicateur,
     reg_indicateur_reduit,
     ope_indicateur,
     file = "../processed_data/analyse_indicateurs_regionaux.rda")


save(reg_indicateur_reduit,
     reg_indicateur_lrr_tendances_lm,
     tab_reg_indicateur_lrr_tendances_lm,
     file = "../processed_data/analyse_indicateurs_regionaux_pour_mk_glm.rda")
```
