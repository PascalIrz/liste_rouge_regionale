---
title: "Liste Rouge Régionale des poissons d'eau douce de Bretagne"
subtitle: "Modèles Linéaires Généralisés à effet mixte"
author: "OFB Bretagne"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne

Script : 13_GLMM

Ce script a pour objectif d'evaluer l'impact qu'ont les différents réseaux sur les tendances des indicateurs régionaux. Il a également l'objectif de regarder l'impact des changements de protocoles sur les stations au cours des années d'études grâce aux modèles linéaires généralisés à effets mixtes. 


# Installation 

## Chargement des packages, fonctions et des données 

```{r Chargement des packages}
## Chargement des packages ----
library(ggthemes)
library(tidyverse)
library(aspe)
library(ggplot2)
library(dplyr)

library(lme4)
library(lmerTest)
library(car)
library(flextable)

library(dplyr)
library(lme4)
library(purrr)
library(broom)
```

```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")

## Chargement des tables ASPE ----
rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)

```

```{r Chargement des données}
## Chargement des données ----
load(file = "../processed_data/calcul_indicateurs_regionaux.rda")
```

```{r Chargement des fonctions}

source(file = "../R/calculate_model_glm.R")
source(file = "../R/application_modeles.R")

```


# Modèles Linéaires Généralisés à effets mixtes (GLMM)

## Introduction

Les modèles linéaires généralisés à effets mixtes combinent les caractéristiques des modèles linéaires généralisés (modéliser des variables non-normalement distribuées, spécialement des données binaires et de comptage) et des modèles à effets mixtes (modéliser des données groupées).


Nous utiliserons dans cette étude le package *lme4* pour ajuster des modèles mixtes. La fonction *lmer* de ce package estime les paramètres d’un modèle linéaire mixte. Les formules utilisées par *lmer* suivent la forme *reponse ~ predicteurs*, avec une syntaxe spécifique pour les effets aléatoires.


## Pré-traitement 

Afin d'appliquer les modèles GLMM, il est nécessaire de construire un jeu de données contenant les valeurs d'un seul indicateur (ici "densite") et d'une espèce (dans un premier temps). Nous utilisons le jeu de données relatifs aux opérations de pêches (*ope_indicateur*) car nous souhaitons observer les effets des réseaux et des protocoles sur les résultats régionaux. 


On part de notre dataframe : ope_indicateur : nous créeons un nouveau jeu de données qui contient les protocoles et les types de réseaux :

```{r}
#Jeu de données complet - ope_selection
ope_indicateur_glm <- ope_indicateur %>%
  filter(indicateur%in% c("biomasse","densite_surface","effectif_total","pourcentage_juveniles")) %>% 
  rename(espece = esp_code_alternatif) %>%
  mef_ajouter_objectif() %>%
  mef_ajouter_type_protocole() %>% 
  filter (!obj_libelle == "DCE – Référence") %>% 
  select(-obj_id)  

ope_indicateur_glm <- ope_indicateur_glm %>% # On s'assure que pop_id est bien en factor
  mutate(pop_id = as.factor(pop_id))

```


On applique la double fonction pour calculer les glm et ce, pour toutes nos combinaisons d'espèces / stades et indicateurs : 

```{r}
result_final_glm <- application_modeles(ope_indicateur_glm)
```


On souhaite pouvoir avoir aussi des modèles linéaires pour les indicateurs régionaux (qui ne dépendent pas de pop_id : c'est le cas de l'indicateur "taux_occurrence" : 

```{r}
#Jeu de données complet - ope_selection
reg_indicateur_lm <- reg_indicateur %>%
  filter(indicateur == "taux_occurrence") %>% 
  rename(espece = esp_code_alternatif) 
```


On applique la fonction pour calculer le lm et ce, pour toutes nos combinaisons d'espèces / stades et de l'indicateur régional : 


```{r}
res <- lm(valeur ~ annee, data = reg_indicateur_lm)

result_final_lm <- summary(res)$coefficients %>%  # Obtenir les résultats résumés
    as.data.frame() %>%
    rename(p_value = `Pr(>|t|)`) %>%
    mutate(sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )) 

```








```{r}
ope_indicateur_glmm_ex2 <- ope_indicateur_glmm_ex %>% 
  mutate(pop_id = as.factor(pop_id))
```

```{r}
model <- lmer(valeur ~ (1 | pop_id) + annee + pro_libelle + obj_libelle, data = ope_indicateur_glmm_ex2)
```


## Application Modèle GLM / GLMM - Effet réseaux et protocoles de pêches 

Explications - https://pmarchand1.github.io/ECL8202/notes_cours/05-Modeles_generalises_mixtes.html 



### Modèles linéaires mixtes dans R 

Dans notre étude, *pop_id* est la variable contenant les identifiants des groupes dans le jeu de données *ope_indicateur_glmm_ex*. Le terme (1 + obj_libelle | pop_id ) indique de modéliser un effet aléatoire du groupe *pop_id* pour l’ordonnée à l’origine (codée “1”) et le coefficient de *obj_libelle*. Si seule l’ordonnée à l’origine variait par groupe, donc si la pente de *valeur* vs. *obj_libelle* était fixée à une seule valeur pour tous les groupes, on pourrait écrire (1 | *pop_id*). *pro_libelle* est un prédicteur définis au niveau du groupe, il apparait donc dans la formule comme n'importe quel autre prédicteur.


```{r}
lmer(valeur ~ obj_libelle + pro_libelle + (1 + obj_libelle | pop_id), data = ope_indicateur_glmm_ex)
```


### Modèles linéaires généralisés à effets mixtes

Les modèles linéaires généralisés à effets mixtes (abbréviés GLMM, pour generalized linear mixed models) combinent les caractéristiques de deux types de modèles : les modèles linéaires généralisés et les modèles linéaires mixtes.


Le package *lme4* contient une fonction *glmer* pour estimer les paramètres d’un GLMM. Celle-ci est semblable à *lmer*, excepté qu’on spécifie la distribution non-normale de la réponse par le biais du paramètre *family*.

```{r}
# estimation du modèle
effet_reseaux_test <- lmerTest::lmer (valeur ~ annee + pro_libelle + (1 + obj_libelle | pop_id), 
                      data = ope_indicateur_glmm_ex)

# ajustement pour l'estimation des effets fixes
mod_effet_reseaux_test <- update(effet_reseaux_test, REML=FALSE)

summary(mod_effet_reseaux_test)


```

D’après la section Fixed effects du sommaire, l’ordonnée à l’origine moyenne est de -8.07 et l’effet moyen du protocole *pêche par ambiance* est de 0.65. Puisque la régression de Poisson utilise un lien log par défaut, ces coefficients signifient que la richesse moyenne est de e puissance 0.65 = ? espèces si pêche par ambiance = 0 et est multipliée par e−(-8.07) = ? (i.e. diminue de 46%) pour chaque augmentation d’une unité du NAP.

D’après la section Random effects, l’écart-type de l’ordonnée à l’origine entre les pop_id est de 0.13 et l’écart-type du coefficient du protocole *peche par ambiance* est de 0.13. S’il s’agissait d’un modèle linéaire mixte, nous obtiendrions aussi un estimé de l’écart-type résiduel (intra-groupe), mais ce n’est pas le cas ici, car la variance résiduelle est fixée par la moyenne dans la distribution de Poisson.



```{r}
ranef(mod_effet_reseaux_test)
```


```{r}
coef(mod_effet_reseaux_test)
```



Comme pour les modèles linéaires généralisés, il est utile de représenter graphiquement la relation non-linéaire entre la réponse et les prédicteurs estimée par le modèle. Le graphique ci-dessous superpose les données observées (points) et les valeurs attendues du modèle (fitted, lignes) pour chaque pop_id.

```{r}
ggplot(ope_indicateur_glmm_ex, aes(x= annee, y = valeur, color = obj_libelle)) +
  geom_point() +
  geom_line(aes(y = fitted (mod_effet_reseaux_test)))
```


