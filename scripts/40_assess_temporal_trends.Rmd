---
title: "Trends in Fish-based Index in French rivers"
subtitle: "Population trend indicators"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
#  bookdown::word_document2
always_allow_html: true
params:
  refnet_start: 2013
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Load packages and data

```{r}
# install packages
# devtools::install_github("pascalirz/aspe")
library(aspe)
library(tidyverse)
library(trend)

# install custom functions
source("../R/functions.R")

# load data
load(file = "../processed_data/30_indicators.RData")
```

# Aim of this file

The aim of this file is to get the dataframes that will further be used to plot the yearly indicators against year, along with linear trend. We want the regression line to be solid only when the slope is significantly different from zero (p = 0.05). To avoid temporal autocorrelation issues, this significance is estimated by a Mann-Kendall non-parametric rank test (and the slope direction by Sen-Theil regression).

The two families of indicators considered are :

- FBI metrics
- population indicators

Hence, the trends significance are assessed for each indicator and joined to the yearly indicators dataframes.

Ultimately, the populations indicators dataframes are stacked, which will allow to produce nice gridded plots and synthetic tables.

# FBI scores

## Trend FBI percentiles

```{r}
# both networks since 2007
# fbi_trends_since_2007a <- fbi_quartiles %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p50) %>% 
#   mutate(variable = "p50")
# 
# fbi_trends_since_2007b <- fbi_quartiles %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p25) %>% 
#   mutate(variable = "p25")
# 
# fbi_trends_since_2007c <- fbi_quartiles %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p75) %>% 
#   mutate(variable = "p75")

# fbi_trends_since_2007 <- fbi_quartiles %>% 
#   pivot_longer(p25:pc_bad_or_better) %>% 
#   tester_pente_mk_multi2(var_groupe1 = network,
#                          var_groupe2 = name,
#                          var_x = annee,
#                          var_y = value) %>% 
#   mutate(period = "2007-2022")
  

# since 2007

# fbi_trends_since_2007 <- fbi_trends_since_2007a %>% 
#   rbind(fbi_trends_since_2007b) %>% 
#   rbind(fbi_trends_since_2007c) %>% 
#   mutate(period = "2007-2022")

# refnet since params$refnet_start
fbi_trends_since_refnet_start <- fbi_quartiles %>% 
 # filter(!(annee < params$refnet_start & network == "REFNET")) %>% 
  pivot_longer(p25:pc_bad_or_better) %>% 
  tester_pente_mk_multi2(var_groupe1 = network,
                         var_groupe2 = name,
                         var_x = annee,
                         var_y = value) %>% 
  mutate(period = ifelse(
    network == "REFNET",
    paste0(params$refnet_start, "-2022"),
    "2007-2022"))

# fbi_trends_since_refnet_start_a <- fbi_quartiles %>% 
#   filter(!(annee < params$refnet_start & network == "REFNET")) %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p50) %>% 
#   mutate(variable = "p50")
# 
# fbi_trends_since_refnet_start_b <- fbi_quartiles %>% 
#   filter(!(annee < params$refnet_start & network == "REFNET")) %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p25) %>% 
#   mutate(variable = "p25")
# 
# fbi_trends_since_refnet_start_c <- fbi_quartiles %>% 
#   filter(!(annee < params$refnet_start & network == "REFNET")) %>% 
#   tester_pente_mk_multi(var_groupe = network,
#                         var_x = annee,
#                         var_y = p75) %>% 
#   mutate(variable = "p75")
# 
# fbi_trends_since_refnet_start <- fbi_trends_since_refnet_start_a %>% 
#   rbind(fbi_trends_since_refnet_start_b) %>% 
#   rbind(fbi_trends_since_refnet_start_c) %>% 
#   mutate(period = paste0(params$refnet_start, "-2022")) #%>% 
 # filter(network != "REPNET")

# assembly
# NB the REPNET rows are duplicated for the plots
# NB the slope signs is interpreted opposingly for FBI percentiles and percentages above threshold
fbi_trends <- fbi_trends_since_refnet_start %>% 
 # rbind(fbi_trends_since_2007) %>% 
  mutate(trend = case_when(trend == "Increase" & str_length(name) == 3 ~ "Degradation",
                           trend == "Decrease" & str_length(name) == 3 ~ "Improvement",
                           trend == "Increase" & str_length(name) != 3 ~ "Improvement",
                           trend == "Decrease" & str_length(name) != 3 ~ "Degradation",
                           TRUE ~ "No trend")) %>% 
  arrange(network) %>% 
  select(network, period, everything())
```


# FBI metrics

## Calculation

```{r}
metrics_trends <- fbi_metrics_median %>%
  tester_pente_mk_multi2(var_groupe1 = metric,
                         var_groupe2 = network,
                         var_x = annee,
                         var_y = p50) %>% 
  mutate(trend = case_when(trend == "Increase" ~ "Degradation",
                           trend == "Decrease" ~ "Improvement",
                           TRUE ~ "No trend")#,
       #  network = "REPNET"
         ) %>% 
  select(network, metric, everything())
```

## Cleaning

```{r}
metrics_trends_flex <- metrics_trends %>%
  mutate_at(
    .vars = vars(mk_pvalue, sens_slope),
    .funs = round,
    digits = 3
  ) %>%
  set_names(
    c(
      "Network",
      "Metric",
      "Mann-Kendall P-value",
      "Sen's slope",
      "Slope significance",
      "Trend"
    )
  )

metrics_trends_flex
```

# Populations indicators 

## Species modelled occurrence probability

The idea here is to assess whether the species distribution models underlying the FBI perform as well today as they used to, or if a 'drift' can be detected reflecting modifications of the species' ranges. Our hypothesis is that under the effect of broad-scale environmental changes and of local habitat conditions (e.g. improvement of water quality due to Ã  better treatment of sewage), the models lost accuracy. For each species, our indicators of this accuracy are the mismatches between prediction and observation, i.e. the rates of observed presences despite being predicted absent (false absences), and of observed absence despite being predicted present (false presences). The species are considered as predicted present if, and only if, their modeled probability of occurrence exceeds 0.5.

Should a species shift habitat in response to broad-scale changes, both indicators are expected to rise. Should a species expand, the false presences are expected to decrease and false absences to increase, and reverse in case of range contraction. 

We acknowledge that uncertainty exists in detection probability, that may vary across species, however, we consider that it should be rather constant in time, and hence not affect the temporal trends.

### Percentage false absences

REPNET

```{r}
confusion_repnet <- confusion %>%
  filter(network == "REPNET")

trend_pc_pred_abs_obs_pres_repnet <- confusion_repnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_abs_obs_pres) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_false_absences_repnet <- confusion_repnet %>%
  mutate(variable = "false_absences") %>%
  left_join(trend_pc_pred_abs_obs_pres_repnet) %>% 
    select(esp_nom_latin,
           annee,
           variable,
           value = pc_pred_abs_obs_pres,
           sig,
           trend)
```

REFNET

```{r}
confusion_refnet <- confusion %>%
  filter(network == "REFNET")

trend_pc_pred_abs_obs_pres_refnet <- confusion_refnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_abs_obs_pres) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_false_absences_refnet <- confusion_refnet %>%
  mutate(variable = "false_absences") %>%
  left_join(trend_pc_pred_abs_obs_pres_refnet) %>% 
    select(esp_nom_latin,
           annee,
           variable,
           value = pc_pred_abs_obs_pres,
           sig,
           trend)
```

### Percentage false presences

REPNET

```{r}
trend_pc_pred_pres_obs_abs_repnet <- confusion_repnet %>% 
  filter(!is.na(pc_pred_pres_obs_abs)) %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_pres_obs_abs) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_false_presences_repnet <- confusion_repnet %>%
  mutate(variable = "false_presences") %>%
  left_join(trend_pc_pred_pres_obs_abs_repnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = pc_pred_pres_obs_abs,
         sig,
         trend)
```

REFNET

```{r}
trend_pc_pred_pres_obs_abs_refnet <- confusion_refnet %>% 
  filter(!is.na(pc_pred_pres_obs_abs)) %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_pres_obs_abs) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_false_presences_refnet <- confusion_refnet %>%
  mutate(variable = "false_presences") %>%
  left_join(trend_pc_pred_pres_obs_abs_refnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = pc_pred_pres_obs_abs,
         sig,
         trend)
```

### Percentage true presences

REPNET

```{r}
trend_pc_pred_pres_obs_pres_repnet <- confusion_repnet %>% 
  filter(!is.na(pc_pred_pres_obs_pres)) %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_pres_obs_pres) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_true_presences_repnet <- confusion_repnet %>%
  mutate(variable = "true_presences") %>%
  left_join(trend_pc_pred_pres_obs_pres_repnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = pc_pred_pres_obs_pres,
         sig,
         trend)
```

REFNET

```{r}
trend_pc_pred_pres_obs_pres_refnet <- confusion_refnet %>% 
  filter(!is.na(pc_pred_pres_obs_pres)) %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = pc_pred_pres_obs_pres) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_true_presences_refnet <- confusion_refnet %>%
  mutate(variable = "true_presences") %>%
  left_join(trend_pc_pred_pres_obs_pres_refnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = pc_pred_pres_obs_pres,
         sig,
         trend)
```

## Species densities

REPNET

```{r}
sp_densities_repnet <- sp_densities %>% 
  filter(network == "REPNET")

trend_sp_densities_repnet <- sp_densities_repnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = density) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_sp_densities_repnet <- sp_densities_repnet %>% 
  mutate(variable = "density") %>% 
  left_join(trend_sp_densities_repnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = density,
         sig,
         trend)  
```

REFNET

```{r}
sp_densities_refnet <- sp_densities %>% 
  filter(network == "REFNET")

trend_sp_densities_refnet <- sp_densities_refnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = density) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_sp_densities_refnet <- sp_densities_refnet %>% 
  mutate(variable = "density") %>% 
  left_join(trend_sp_densities_refnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = density,
         sig,
         trend)  
```

## Species occupancy rate across sites

For each species and each year, this indicator is the ratio of the number of sites where the species was observed by the number of sites surveyed.

REPNET

```{r}
sp_occupancy_repnet <- sp_occupancy %>% 
  filter(network == "REPNET")

trend_sp_occupancy_repnet <- sp_occupancy_repnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = occurency_rate) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_sp_occupancy_repnet <- sp_occupancy_repnet %>% 
  mutate(variable = "occupancy_rate") %>% 
  left_join(trend_sp_occupancy_repnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = occurency_rate,
         sig,
         trend)  
```

REFNET

```{r}
sp_occupancy_refnet <- sp_occupancy %>% 
  filter(network == "REFNET")

trend_sp_occupancy_refnet <- sp_occupancy_refnet %>% 
  tester_pente_mk_multi(var_groupe = esp_nom_latin,
                        var_x = annee,
                        var_y = occurency_rate) %>% 
  select(esp_nom_latin,
         sig,
         trend)

# joining tables for plots
trend_sp_occupancy_refnet <- sp_occupancy_refnet %>% 
  mutate(variable = "occupancy_rate") %>% 
  left_join(trend_sp_occupancy_refnet) %>% 
  select(esp_nom_latin,
         annee,
         variable,
         value = occurency_rate,
         sig,
         trend)  
```

## Species median length

```{r}
# trend_sp_length <- sp_median_length %>% 
#     tester_pente_mk_multi(var_groupe = esp_nom_latin,
#                           var_x = annee,
#                           var_y = median_length) %>% 
#   select(esp_nom_latin,
#          sig,
#          trend)
# 
# # joining tables for plots
# trend_sp_length <- sp_median_length %>% 
#   mutate(variable = "median_length") %>% 
#   left_join(trend_sp_length) %>% 
#   select(esp_nom_latin,
#          annee,
#          variable,
#          value = median_length,
#          sig,
#          trend)  
```

## Joining species trends dataframes

Here, we aim at assembling (stacking) the species trends dataframes in order to allow a grid plot handy for visualising side-by-side all the indicators for each species. 

REPNET

```{r}
sp_trends_repnet <- trend_false_absences_repnet %>%
  bind_rows(trend_false_presences_repnet) %>%
  bind_rows(trend_true_presences_repnet) %>%
  bind_rows(trend_sp_densities_repnet) %>%
 # bind_rows(trend_sp_length) %>%
  bind_rows(trend_sp_occupancy_repnet) %>%
  mutate(
    variable = as.factor(variable),
    variable = fct_relevel(
      variable,
      "density",
      "occupancy_rate",
      "true_presences",
      "false_absences",
      "false_presences"
    )
  )
```

REFNET

```{r}
sp_trends_refnet <- trend_false_absences_refnet %>%
  bind_rows(trend_false_presences_refnet) %>%
  bind_rows(trend_true_presences_refnet) %>%
  bind_rows(trend_sp_densities_refnet) %>%
  # bind_rows(trend_sp_length) %>%
  bind_rows(trend_sp_occupancy_refnet) %>%
  mutate(
    variable = as.factor(variable),
    variable = fct_relevel(
      variable,
      "density",
      "occupancy_rate",
      "true_presences",
      "false_absences",
      "false_presences"
    )
  )
```

# Environment

## Sampling sites characteristics

```{r}
env <- env_surveys %>% 
  group_by(annee, variable, network) %>% 
  summarise(mean_value = mean(value, na.rm = TRUE)) %>% 
  ungroup()
```

REPNET

```{r}
env_repnet <- env %>% 
  filter(network == "REPNET")

trend_env_repnet <- env_repnet %>% 
  tester_pente_mk_multi(var_groupe = variable,
                        var_x = annee,
                        var_y = mean_value) %>% 
  select(variable,
         sig)

# joining tables for plots
trend_env_repnet <- env_repnet %>% 
  left_join(trend_env_repnet)

```

REFNET

```{r}
env_refnet <- env %>% 
  filter(network == "REFNET")

trend_env_refnet <- env_refnet %>% 
  tester_pente_mk_multi(var_groupe = variable,
                        var_x = annee,
                        var_y = mean_value) %>% 
  select(variable,
         sig)

# joining tables for plots
trend_env_refnet <- env_refnet %>% 
  left_join(trend_env_refnet)

```

## Species environmental realised niche

REPNET

```{r}
sp_env_niche_repnet <- sp_env_niche %>% 
  filter(network == "REPNET")

trend_sp_env_niche_repnet <- sp_env_niche_repnet %>% 
  tester_pente_mk_multi2(var_groupe1 = esp_nom_latin,
                         var_groupe2 = variable,
                         var_x = annee,
                         var_y = mean_value) %>% 
  select(esp_nom_latin,
         variable,
         trend)


# joining tables for plots
trend_sp_env_niche_repnet <- sp_env_niche_repnet %>% 
  left_join(trend_sp_env_niche_repnet)
```

REFNET

```{r}
sp_env_niche_refnet <- sp_env_niche %>% 
  filter(network == "REFNET")

trend_sp_env_niche_refnet <- sp_env_niche_refnet %>% 
  tester_pente_mk_multi2(var_groupe1 = esp_nom_latin,
                         var_groupe2 = variable,
                         var_x = annee,
                         var_y = mean_value) %>% 
  select(esp_nom_latin,
         variable,
         trend)


# joining tables for plots
trend_sp_env_niche_refnet <- sp_env_niche_refnet %>% 
  left_join(trend_sp_env_niche_refnet)
```


# Trend tests by point

To assess the significance of a monotonous temporal trend for each sampling point, a Mann-Kendall non-parametric test is performed. Sen-Theil slope is then estimated in order to retrieve its sign. As the FBI score is a measure of degradation, both are positively correlated. Hence, if the trend is significant and the sign is positive, FBI scores tend to increase through time, reflecting a degradation of the river. On the contrary, a significant trend with a positive sign indicates an improvement on 'river health'. The same applied to FBI metrics. 

## FBI

```{r}
# count nb FBI data per sampling point
n_fbi_by_point <- fbi %>% 
  group_by(pop_id) %>% 
  summarise(n_years = n_distinct(annee))

# at least 3 data per point required for the tests
selected_point_ids <- n_fbi_by_point %>% 
  filter(n_years > 3) %>% 
  pull(pop_id)

# apply tests to each sampling point
fbi_trends_by_point <- fbi %>%
  filter(!is.na(ipr),
         pop_id %in% selected_point_ids) %>% 
  tester_pente_mk_multi(var_groupe = pop_id,
                        var_x = annee,
                        var_y = ipr) %>% 
  # translate slope into interpretable FBI trend
  mutate(trend = case_when(
    trend == "Decrease" ~"Improvement",
    trend == "Increase" ~"Degradation",
    TRUE ~ "No trend"
  )) %>% 
  # add bassin
  left_join(y = fbi_metrics %>% 
              select(pop_id, unh_libelle) %>% 
              distinct())
```

## FBI metrics

```{r}
# apply tests to each sampling point
fbi_metrics_trends_by_point <- fbi_metrics %>%
  filter(!is.na(value),
         pop_id %in% selected_point_ids) %>%
  tester_pente_mk_multi2(
    var_groupe1 = pop_id,
    var_groupe2 = metric,
    var_x = annee,
    var_y = value
  ) %>%
  # translate slope into interpretable FBI trend
  mutate(
    trend = case_when(
      trend == "Decrease" ~ "Improvement",
      trend == "Increase" ~ "Degradation",
      TRUE ~ "No trend"
    )
  )
```

# Saving

```{r}
save(fbi_trends,
     metrics_trends,
     metrics_trends_flex,
     points_ref_status_2_cats,
     sp_trends_repnet,
     sp_trends_refnet,
     trend_env_repnet,
     trend_env_refnet,
     trend_sp_env_niche_repnet,
     trend_sp_env_niche_refnet,
     fbi_trends_by_point,
     fbi_metrics_trends_by_point,
     file = "../processed_data/40_trends.RData")
```

