---
title: "05_pre_traitements_donnees_env"
author: "Léa Bouchet"
date: "2024-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objectif : Dynamique de population des poissons d'eau douce de Bretagne - 05_pre_traitements_donnees_env

Il s’agit de réaliser les pré-traitements des données environnementales utilisées pour l’étude. Cette partie permet notamment d’observer les erreurs ou incohérences présentes dans le jeu de données relatif aux variables environnementales. Il s'agit d'un travail de mise en qualité des données. Il s'agit également de s’occuper des valeurs manquantes (appelées « NA ») présentes dans le jeu de données. En effet, des données peuvent être non renseignées d’une année à l’autre et la valeur étant, pour certains paramètres, non changeante d’une année à l’autre, ces dernières sont remplacées par les données médianes des mêmes stations. 

# I. Installation : 
## I.A : Chargement des packages, fonctions et des données : 
```{r}

## Chargement des packages ----
library(tidyverse)
library(aspe)
library(ggplot2)
library(zoo)
library(lemon)

## Chargement des données ----
load(file = "../processed_data/selection_pop_ope.rda")
rdata_tables <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^tables")
load(rdata_tables)

mei_table <- misc_nom_dernier_fichier(
  repertoire = "../../../../projets/ASPE/raw_data/rdata",
  pattern = "^mei")
load(mei_table)

```

# II. Constitution du jeu de données : 
## II.A : Création d'un dataframe : 

Création d'un dataframe contenant les variables environnementales relatives aux opérations contenues dans la passerelle (cf 00_selection_pop_ope).  

```{r}
# Création du dataframe : 
ope_selection_param_env <- passerelle %>% 
  select(-lop_id,
         -pre_id) %>% 
  mef_ajouter_ope_env() %>% 
  mef_ajouter_ope_date() %>% 
  select(-ope_date,
         -sta_id,
         -distance_mer,
         -obj_libelle,
         -obj_id)%>%
  distinct() %>% 
  pivot_longer(altitude:temp_janvier,
               names_to = "parametre",
               values_to= "valeur") %>% 
  distinct()
  
```

## II.B : Gestion des "NA" : 

Les données manquantes (NA) sont isolées dans un jeu de données extérieur afin de les identifier. L'ensemble des données environnementales sont ensuite triées par paramètres et par années. Les NA sont remplacés par les médianes des autres données relatives aux points de prélèvements. 

```{r}
# Les NA sont indiquées dans un nouveau jeu de données : 
N_A <- which(apply(is.na(ope_selection_param_env), 1, any)) 
print(ope_selection_param_env[N_A, ]) # Observation des NA



ope_selection_param_env <- ope_selection_param_env %>% 
  arrange(parametre, annee)%>%  # Tri des données environnementales globales
  group_by(parametre,pop_id) %>%
  mutate(valeur = ifelse(is.na(valeur), # NA remplacées par les médianes
                         zoo::na.aggregate(valeur, median), valeur))

```

# III. Représentation graphique : 

Création d'une représentation graphique permettant de remarquer facilement les valeurs abérantes du jeu de données. 

```{r, fig.height = 55, fig.width = 10}
# Représentation de mes variables environnements (avec facet_wrap) : 
ope_selection_param_env %>% 
  ggplot(aes(x=annee, y=valeur)) +
  geom_bar(stat="identity", fill = "darkcyan") +
  facet_wrap(vars(pop_id, parametre),
             ncol = 8,
             scales="free_y") +
  labs(title = "Diagrammes en baton des variables environnementales", 
       x = "Années", 
       y = "Valeurs") +
  theme(
    axis.title.y = element_text (color = "black"),
    axis.text.y.left = element_text (color = "black"),
    strip.text = element_text(size = 8))



# Représentation de mes variables environnements (avec facet_grid) : 
# !!! ATTENTION !!! Ici problème d'échelle non résolu
ope_selection_param_env %>% 
  ggplot(mapping = aes(x = annee, y = valeur), scales = "free") +
  geom_bar(stat="identity", fill = "darkcyan") +
  facet_rep_grid(pop_id ~ parametre, 
                 scales= "free", 
                 repeat.tick.labels = TRUE) +
  labs(title = "Diagrammes en baton des variables environnementales", 
       x = "Années", 
       y = "Valeurs") +
  theme_bw()

```



# Sauvegarde : 
```{r}
save(ope_selection_param_env,
     file = "../processed_data/pre_traitements_donnees_env.rda")
```

